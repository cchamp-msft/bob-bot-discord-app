flowchart TD
    subgraph Discord["Discord (External)"]
        A["üë§ User sends:<br/><code>@BobBot !weather Seattle</code>"]
    end

    subgraph DiscordManager["discordManager.ts ‚Äî Event Listener"]
        B["client.on('messageCreate')<br/>‚Üí messageHandler.handleMessage(message)"]
    end

    subgraph MessageHandler["messageHandler.ts ‚Äî handleMessage()"]
        C["Strip @mention ‚Üí content = <b>'!weather Seattle'</b>"]
        D["Collect conversation history<br/><code>collectReplyChain()</code> or <code>collectDmHistory()</code>"]
        E{"<b>findKeyword(content)</b><br/>Regex match at start of message?<br/><i>sorted longest-first</i>"}

        E1["‚úÖ Match: <b>'!weather'</b><br/><code>api: 'accuweather'</code>"]
        E2["‚ùå No regex match<br/><i>(would enter two-stage path)</i>"]

        F{"<code>apiKeywordMatched?</code><br/>keywordConfig.api !== 'ollama'?"}
        G["‚úÖ Yes ‚Äî <b>Direct API routing path</b>"]
        H["‚ùå No ‚Äî <b>Two-stage evaluation path</b><br/><code>executeWithTwoStageEvaluation()</code>"]

        I["Strip keyword from content<br/><code>stripKeyword()</code><br/>content = <b>'Seattle'</b>"]
        J["Reply: ‚è≥ Processing your request..."]
    end

    subgraph APIRouter["apiRouter.ts ‚Äî executeRoutedRequest()"]
        K["Receive: keywordConfig, content, requester, history"]
        L["Check: <code>needsFinalPass = keywordConfig.finalOllamaPass</code><br/>‚Üí <b>false</b> (default weather route)"]

        subgraph PrimaryAPI["Stage 1: Primary API Request"]
            M["<code>requestQueue.execute('accuweather', ...)</code>"]
            N["<code>apiManager.executeRequest('accuweather', ...)</code><br/>mode = full"]
            O["AccuWeather API call<br/>‚Üí Returns weather data for Seattle"]
            P["<code>extractStageResult('accuweather', result)</code><br/>‚Üí stages.push(primaryExtracted)"]
        end

        Q{"Primary API success?"}
        Q1a{"Retry enabled?"}
        Q1b["üîÑ Ollama refines params<br/><code>buildRetryUserPrompt()</code>"]
        Q1c["‚ùå Return error RoutedResult"]
        Q2["‚úÖ Success ‚Äî check finalOllamaPass"]

        R{"<code>needsFinalPass && api !== 'ollama'?</code>"}
        R1["Skip ‚Äî primary was already Ollama"]

        subgraph FinalPass["Stage 2: Final Ollama Refinement Pass"]
            S["<code>evaluateContextWindow()</code><br/>Filter conversation history for relevance"]
            T["Build <code>&lt;external_data&gt;</code> block:<br/><code>formatAccuWeatherExternalData(location, data)</code><br/>‚Üí <code>&lt;accuweather_data source='weather' location='Seattle'&gt;</code>"]
            U["<code>assembleReprompt()</code><br/>System: persona only <i>(NO abilities/keyword rules)</i><br/>User: <code>&lt;conversation_history&gt;</code> + <code>&lt;external_data&gt;</code> + <code>&lt;current_question&gt;</code>"]
            V["<code>requestQueue.execute('ollama', ...)</code><br/>‚Üí <code>apiManager.executeRequest('ollama', ...)</code><br/>model = OLLAMA_FINAL_PASS_MODEL or default"]
            W["(Optional) Ollama final-pass refinement<br/>when enabled on a keyword"]
        end

        X["Return <b>RoutedResult</b><br/><code>{ finalResponse, finalApi: 'ollama', stages }</code>"]
    end

    subgraph Dispatch["messageHandler.ts ‚Äî dispatchResponse()"]
        Y{"Switch on <code>finalApi</code>"}
        Y1["<code>handleComfyUIResponse()</code>"]
        Y2["<code>handleOllamaResponse()</code> ‚úÖ <i>(our path)</i>"]
        Y3["<code>handleAccuWeatherResponse()</code>"]
        Y4["<code>handleNFLResponse()</code>"]
        Y5["<code>handleSerpApiResponse()</code>"]
        Y6["<code>handleMemeResponse()</code>"]
    end

    subgraph Response["messageHandler.ts ‚Äî handleOllamaResponse()"]
        Z["<code>chunkText(text)</code><br/>Split into Discord-safe chunks"]
        Z1["<code>processingMessage.edit(chunks[0])</code><br/>Replace ‚è≥ with first chunk"]
        Z2["<code>channel.send(chunks[i])</code><br/>Send overflow chunks as follow-ups"]
        Z3["<code>logger.logReply()</code>"]
    end

    subgraph TwoStage["messageHandler.ts ‚Äî executeWithTwoStageEvaluation()<br/><i>(alternate path ‚Äî shown for completeness)</i>"]
        TS1["<code>evaluateContextWindow()</code> ‚Äî filter history<br/><i>(only when contextFilterEnabled)</i>"]
        TS2["<code>assemblePrompt()</code><br/>System: persona + abilities + keyword rules<br/>User: XML-tagged prompt with <code>&lt;thinking_and_output_rules&gt;</code>"]
        TS3["<code>requestQueue.execute('ollama', ...)</code><br/>Ollama responds with abilities awareness"]
        TS4{"<code>parseFirstLineKeyword()</code><br/>First line = exact keyword?"}
        TS5["‚úÖ Keyword found"]
        TS5a{"Required params<br/>missing?"}
        TS5b["<code>inferAbilityParameters()</code><br/>Ollama extracts params from natural language"]
        TS5c["<code>executeRoutedRequest()</code><br/><i>(forced finalOllamaPass = true)</i>"]
        TS9["‚ùå No keyword ‚Üí return Ollama response as direct chat"]
    end

    A --> B --> C --> D --> E
    E -->|"'!weather' matches regex"| E1
    E -->|"e.g. 'is it going to rain?'"| E2
    E1 --> F
    F -->|"accuweather ‚â† ollama"| G
    F -->|"api = ollama or no match"| H
    G --> I --> J --> K
    K --> L --> M --> N --> O --> P --> Q
    Q -->|"fail"| Q1a
    Q1a -->|"yes"| Q1b --> M
    Q1a -->|"no"| Q1c
    Q -->|"success"| Q2 --> R
    R -->|"true ‚úÖ"| S --> T --> U --> V --> W --> X
    R -->|"primary was ollama"| R1
    X --> Y
    Y -->|"comfyui"| Y1
    Y -->|"ollama"| Y2
    Y -->|"accuweather"| Y3
    Y -->|"nfl"| Y4
    Y -->|"serpapi"| Y5
    Y -->|"meme"| Y6
    Y2 --> Z --> Z1 --> Z2 --> Z3

    H --> TS1 --> TS2 --> TS3 --> TS4
    TS4 -->|"yes"| TS5 --> TS5a
    TS5a -->|"yes"| TS5b --> TS5c
    TS5a -->|"no"| TS5c
    TS4 -->|"no"| TS9

    E2 --> H

    style A fill:#5865F2,color:#fff
    style E fill:#f9a825,color:#000
    style F fill:#f9a825,color:#000
    style Q fill:#f9a825,color:#000
    style R fill:#f9a825,color:#000
    style TS4 fill:#f9a825,color:#000
    style TS5a fill:#f9a825,color:#000
    style Q1a fill:#f9a825,color:#000
    style E1 fill:#4caf50,color:#fff
    style G fill:#4caf50,color:#fff
    style W fill:#4caf50,color:#fff
    style X fill:#4caf50,color:#fff
    style Z3 fill:#4caf50,color:#fff
    style Q1c fill:#f44336,color:#fff
    style Discord fill:#5865F222
    style DiscordManager fill:#7289DA22
    style MessageHandler fill:#43b58122
    style APIRouter fill:#ff980022
    style PrimaryAPI fill:#2196F322
    style FinalPass fill:#9c27b022
    style Dispatch fill:#60768822
    style Response fill:#00968822
    style TwoStage fill:#78909c22