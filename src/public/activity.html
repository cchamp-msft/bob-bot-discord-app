<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot Activity</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
    --blue: #42a5f5;
    --purple: #ab47bc;
    --green: #66bb6a;
    --orange: #ffa726;
    --red: #ef5350;
  }

  /* Theme - Grayscale */
  .theme-grayscale {
    --bg: #f0f0f0;
    --surface: #e0e0e0;
    --surface2: #d0d0d0;
    --accent: #666666;
    --accent2: #555555;
    --text: #333333;
    --text-dim: #666666;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #cccccc;
    --blue: #1976d2;
    --purple: #7b1fa2;
    --green: #388e3c;
    --orange: #f57c00;
    --red: #d32f2f;
  }

  /* Theme - Green */
  .theme-green {
    --bg: #0a251c;
    --surface: #0d3b29;
    --surface2: #11573c;
    --accent: #4caf50;
    --accent2: #388e3c;
    --text: #e8f5e9;
    --text-dim: #a5d6a7;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #1b5e20;
    --blue: #42a5f5;
    --purple: #ab47bc;
    --green: #66bb6a;
    --orange: #ffa726;
    --red: #ef5350;
  }

  /* Theme - Orange */
  .theme-orange {
    --bg: #2e1a10;
    --surface: #442715;
    --surface2: #60381f;
    --accent: #ff9800;
    --accent2: #f57c00;
    --text: #fff3e0;
    --text-dim: #ffcc80;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #e65100;
    --blue: #42a5f5;
    --purple: #ab47bc;
    --green: #66bb6a;
    --orange: #ffa726;
    --red: #ef5350;
  }

  /* Theme - Purple */
  .theme-purple {
    --bg: #1a0d3d;
    --surface: #2d1a5c;
    --surface2: #4a2a8c;
    --accent: #9c27b0;
    --accent2: #7b1fa2;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #6a3d9e;
    --blue: #42a5f5;
    --purple: #ab47bc;
    --green: #66bb6a;
    --orange: #ffa726;
    --red: #ef5350;
  }

  /* Theme - Black with Cyan Accents */
  .theme-black-cyan {
    --bg: #000000;
    --surface: #111111;
    --surface2: #222222;
    --accent: #00ffff;
    --accent2: #00b3b3;
    --text: #ffffff;
    --text-dim: #cccccc;
    --ok: #00ff00;
    --warn: #ffff00;
    --err: #ff0000;
    --border: #333333;
    --blue: #00e5ff;
    --purple: #b388ff;
    --green: #69f0ae;
    --orange: #ffd740;
    --red: #ff5252;
  }

  /* Dark theme (applied via JS) */
  .theme-dark {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
    --blue: #42a5f5;
    --purple: #ab47bc;
    --green: #66bb6a;
    --orange: #ffa726;
    --red: #ef5350;
  }

  /* Theme Selector UI */
  .theme-selector {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .theme-option {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #000000;
    transition: transform 0.2s ease;
    background-color: var(--surface2);
  }

  .theme-option:hover {
    transform: scale(1.2);
  }

  .theme-option.active {
    transform: scale(1.2);
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #000000;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--surface);
    padding: 12px 24px;
    border-bottom: 2px solid var(--accent);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }
  header h1 { font-size: 1.2em; font-weight: 600; }
  header .spacer { flex: 1; }
  header .meta {
    font-size: 0.78em;
    color: var(--text-dim);
  }
  header button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.82em;
  }
  header button:hover { background: var(--accent); }

  /* Privacy notice */
  .privacy-notice {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 8px 24px;
    font-size: 0.78em;
    color: var(--text-dim);
    line-height: 1.5;
    flex-shrink: 0;
  }
  .privacy-notice em { font-style: italic; }
  .privacy-notice a {
    color: var(--blue);
    text-decoration: underline;
    cursor: pointer;
  }
  .privacy-notice a:hover { color: var(--accent); }

  /* Privacy policy dialog â€” hidden until .showModal() adds [open] */
  dialog.policy-dialog {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0;
    max-width: 720px;
    width: 90vw;
    max-height: 85vh;
  }
  dialog.policy-dialog[open] {
    display: flex;
    flex-direction: column;
  }
  dialog.policy-dialog::backdrop { background: rgba(0,0,0,0.7); }
  dialog.policy-dialog .policy-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  dialog.policy-dialog .policy-header h2 {
    font-size: 1em;
    font-weight: 600;
    margin: 0;
  }
  dialog.policy-dialog .policy-body {
    padding: 16px 20px;
    overflow-y: auto;
    flex: 1;
    font-size: 0.88em;
    line-height: 1.7;
  }
  dialog.policy-dialog .policy-body h1 { font-size: 1.3em; margin: 16px 0 8px; }
  dialog.policy-dialog .policy-body h2 { font-size: 1.1em; margin: 14px 0 6px; }
  dialog.policy-dialog .policy-body h3 { font-size: 1em; margin: 12px 0 4px; }
  dialog.policy-dialog .policy-body p { margin: 6px 0; }
  dialog.policy-dialog .policy-body ul,
  dialog.policy-dialog .policy-body ol { margin: 6px 0; padding-left: 24px; }
  dialog.policy-dialog .policy-body li { margin: 2px 0; }
  dialog.policy-dialog .policy-body hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 12px 0;
  }
  dialog.policy-dialog .policy-body code {
    background: var(--bg);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.92em;
  }
  dialog.policy-dialog .policy-body a {
    color: var(--blue);
    text-decoration: underline;
  }
  dialog.policy-dialog .policy-body strong { font-weight: 600; }
  dialog.policy-dialog .policy-body em { font-style: italic; }

  /* Timeline */
  .timeline {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .timeline:empty::after {
    content: 'Waiting for activityâ€¦';
    color: var(--text-dim);
    text-align: center;
    margin-top: 40px;
    font-style: italic;
  }

  /* Event card */
  .event {
    background: var(--surface);
    border-left: 3px solid var(--border);
    border-radius: 4px;
    padding: 10px 14px;
    animation: fadeIn 0.3s ease;
  }
  .event.message_received { border-left-color: var(--blue); }
  .event.routing_decision  { border-left-color: var(--purple); }
  .event.bot_reply          { border-left-color: var(--green); }
  .event.error              { border-left-color: var(--red); }
  .event.warning            { border-left-color: var(--orange); }

  .event .ts {
    font-size: 0.72em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .event .narrative {
    font-size: 0.92em;
    line-height: 1.5;
    white-space: pre-wrap;
  }

  /* Type icon dot */
  .event .type-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }
  .event.message_received .type-dot { background: var(--blue); }
  .event.routing_decision  .type-dot { background: var(--purple); }
  .event.bot_reply          .type-dot { background: var(--green); }
  .event.error              .type-dot { background: var(--red); }
  .event.warning            .type-dot { background: var(--orange); }

  /* Inline images */
  .event .images {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  .event .images img {
    max-width: 300px;
    max-height: 200px;
    border-radius: 4px;
    cursor: pointer;
    object-fit: contain;
    background: #0d0d1a;
  }

  /* Image dialog */
  dialog {
    background: rgba(0,0,0,0.9);
    border: none;
    padding: 0;
    max-width: 95vw;
    max-height: 95vh;
  }
  dialog::backdrop { background: rgba(0,0,0,0.7); }
  dialog img {
    max-width: 95vw;
    max-height: 90vh;
    object-fit: contain;
    display: block;
  }
  dialog .close-btn {
    position: absolute;
    top: 8px; right: 12px;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.8em;
    cursor: pointer;
    line-height: 1;
    z-index: 1;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
  <header>
    <h1>ðŸ¤– Activity</h1>
    <span class="spacer"></span>
    <div class="theme-selector">
      <div class="theme-option theme-dark" data-theme="dark" title="Dark" role="button" aria-label="Dark theme" tabindex="0"></div>
      <div class="theme-option theme-grayscale" data-theme="grayscale" title="Grayscale" role="button" aria-label="Grayscale theme" tabindex="0"></div>
      <div class="theme-option theme-green" data-theme="green" title="Green" role="button" aria-label="Green theme" tabindex="0"></div>
      <div class="theme-option theme-orange" data-theme="orange" title="Orange" role="button" aria-label="Orange theme" tabindex="0"></div>
      <div class="theme-option theme-purple" data-theme="purple" title="Purple" role="button" aria-label="Purple theme" tabindex="0"></div>
      <div class="theme-option theme-black-cyan" data-theme="black-cyan" title="Black/Cyan" role="button" aria-label="Black/Cyan theme" tabindex="0"></div>
    </div>
    <span class="meta" id="lastUpdated">â€”</span>
    <button id="refreshBtn">â†» Refresh</button>
  </header>

  <div class="privacy-notice">
    <em>This</em> activity log is not saved, but other logging with more details are collected by the host. See <a id="privacyLink">PRIVACY_POLICY.md</a> for details.
  </div>

  <dialog id="policyDialog" class="policy-dialog">
    <div class="policy-header">
      <h2>Privacy Policy</h2>
      <button class="close-btn" id="policyClose">Ã—</button>
    </div>
    <div class="policy-body" id="policyBody">Loadingâ€¦</div>
  </dialog>

  <div class="timeline" id="timeline"></div>

  <!-- Activity key prompt overlay -->
  <div id="keyOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:28px 32px;max-width:420px;width:90%;text-align:center;">
      <h2 style="margin-bottom:12px;font-size:1.1em;">ðŸ”‘ Activity Key Required</h2>
      <p style="font-size:0.85em;color:var(--text-dim);margin-bottom:16px;">
        Send <code style="background:var(--surface2);padding:2px 6px;border-radius:3px;">activity_key</code> to the bot in Discord to get a temporary access key.
      </p>
      <input type="text" id="keyInput" placeholder="Paste your key here" style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.9em;margin-bottom:12px;">
      <div id="keyError" style="color:var(--err);font-size:0.8em;margin-bottom:10px;display:none;">Invalid or expired key. Please request a new one.</div>
      <button id="keySubmit" style="background:var(--accent);border:none;color:#fff;padding:8px 20px;border-radius:4px;cursor:pointer;font-size:0.9em;">Unlock</button>
    </div>
  </div>

  <dialog id="imageDialog">
    <button class="close-btn" id="dialogClose">Ã—</button>
    <img id="dialogImg" src="" alt="Enlarged image">
  </dialog>

<script>
(function() {
  'use strict';

  const timeline = document.getElementById('timeline');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const refreshBtn = document.getElementById('refreshBtn');
  const dialog = document.getElementById('imageDialog');
  const dialogImg = document.getElementById('dialogImg');
  const dialogClose = document.getElementById('dialogClose');
  const policyDialog = document.getElementById('policyDialog');
  const policyBody = document.getElementById('policyBody');
  const policyClose = document.getElementById('policyClose');
  const privacyLink = document.getElementById('privacyLink');

  // â”€â”€ Key & session management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const keyOverlay = document.getElementById('keyOverlay');
  const keyInput = document.getElementById('keyInput');
  const keySubmit = document.getElementById('keySubmit');
  const keyError = document.getElementById('keyError');

  function getStoredKey() {
    return sessionStorage.getItem('activityKey') || '';
  }

  function storeKey(k) {
    sessionStorage.setItem('activityKey', k);
  }

  function getStoredSession() {
    return sessionStorage.getItem('activitySession') || '';
  }

  function storeSession(token) {
    sessionStorage.setItem('activitySession', token);
  }

  function clearAuth() {
    sessionStorage.removeItem('activityKey');
    sessionStorage.removeItem('activitySession');
  }

  /** Whether we have either a session token or a raw key to try. */
  function hasCredentials() {
    return !!(getStoredSession() || getStoredKey());
  }

  function showKeyPrompt(errorMsg) {
    keyError.style.display = errorMsg ? 'block' : 'none';
    if (errorMsg) keyError.textContent = errorMsg;
    keyOverlay.style.display = 'flex';
    keyInput.value = '';
    keyInput.focus();
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
  }

  function hideKeyPrompt() {
    keyOverlay.style.display = 'none';
  }

  keySubmit.addEventListener('click', function() {
    var k = keyInput.value.trim();
    if (!k) return;
    storeKey(k);
    hideKeyPrompt();
    fullRefresh();
    pollTimer = setInterval(poll, POLL_INTERVAL);
  });

  keyInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') keySubmit.click();
  });

  let lastTimestamp = null;
  let pollTimer = null;
  const POLL_INTERVAL = 4000; // 4 seconds
  let _defaultThemeApplied = false;

  // â”€â”€ Theme Switching (session-only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyTheme(themeName) {
    var root = document.documentElement;
    root.className = root.className.replace(/theme-[\w-]+/g, '');
    root.classList.add('theme-' + themeName);
    document.querySelectorAll('.theme-option').forEach(function(option) {
      option.classList.toggle('active', option.dataset.theme === themeName);
    });
    sessionStorage.setItem('activityTheme', themeName);
  }

  // Apply session theme immediately to avoid flash (falls back to dark)
  applyTheme(sessionStorage.getItem('activityTheme') || 'dark');

  // Attach theme click handlers
  document.querySelectorAll('.theme-option').forEach(function(option) {
    option.addEventListener('click', function() {
      applyTheme(option.dataset.theme);
    });
  });

  // â”€â”€ Minimal markdownâ†’HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function mdToHtml(md) {
    return md
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      // Headings
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      // Horizontal rule
      .replace(/^---+$/gm, '<hr>')
      // Bold + italic, bold, italic
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // Inline code
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      // Links [text](url)
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
      // Unordered list items
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      // Wrap consecutive <li> in <ul>
      .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
      // Paragraphs â€” blank-line separated blocks
      .replace(/\n{2,}/g, '</p><p>')
      .replace(/^/, '<p>').replace(/$/, '</p>')
      // Clean up empty paragraphs around block elements
      .replace(/<p>\s*(<h[123]|<hr|<ul|<\/ul)/g, '$1')
      .replace(/(<\/h[123]>|<hr>|<\/ul>)\s*<\/p>/g, '$1');
  }

  let policyLoaded = false;
  let policyLoading = false;

  function renderPolicyError() {
    policyBody.innerHTML =
      '<p style="color:var(--err)">Could not load privacy policy.</p>' +
      '<button id="policyRetry" style="margin-top:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:4px;cursor:pointer;">Retry</button>';
    document.getElementById('policyRetry').addEventListener('click', function() {
      policyLoaded = false;
      policyLoading = false;
      loadAndShowPolicy();
    });
  }

  function loadAndShowPolicy() {
    if (policyLoaded) {
      policyDialog.showModal();
      return;
    }
    if (policyLoading) return;
    policyLoading = true;
    policyBody.textContent = 'Loading\u2026';
    policyDialog.showModal();
    fetch('/api/privacy-policy')
      .then(function(res) {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.text();
      })
      .then(function(text) {
        policyBody.innerHTML = mdToHtml(text);
        policyLoaded = true;
      })
      .catch(function() {
        renderPolicyError();
      })
      .finally(function() {
        policyLoading = false;
      });
  }

  privacyLink.addEventListener('click', loadAndShowPolicy);
  policyClose.addEventListener('click', function() { policyDialog.close(); });
  policyDialog.addEventListener('click', function(e) {
    if (e.target === policyDialog) policyDialog.close();
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function formatTime(isoStr) {
    const d = new Date(isoStr);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function escapeHtml(text) {
    const el = document.createElement('span');
    el.textContent = text;
    return el.innerHTML;
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * Format narrative text: thoughts and descriptive prefixes are
   * italicized, but actual message content stays in normal style.
   */
  function formatNarrative(ev) {
    if (ev.type === 'message_received' || ev.type === 'bot_reply') {
      var colonIdx = ev.narrative.indexOf(': ');
      if (colonIdx !== -1) {
        var prefix = ev.narrative.substring(0, colonIdx + 1);
        var content = ev.narrative.substring(colonIdx + 2);
        return '<em>' + escapeHtml(prefix) + '</em> ' + escapeHtml(content);
      }
    }
    return '<em>' + escapeHtml(ev.narrative) + '</em>';
  }

  function createEventCard(ev) {
    const card = document.createElement('div');
    card.className = 'event ' + ev.type;
    card.dataset.id = ev.id;

    let html = '<div class="ts">' + formatTime(ev.timestamp) + '</div>';
    html += '<div class="narrative"><span class="type-dot"></span>' + formatNarrative(ev) + '</div>';

    if (ev.imageUrls && ev.imageUrls.length > 0) {
      html += '<div class="images">';
      ev.imageUrls.forEach(function(url) {
        html += '<img src="' + escapeHtml(url) + '" alt="Generated image" loading="lazy">';
      });
      html += '</div>';
    }

    card.innerHTML = html;

    // Attach image click handlers
    card.querySelectorAll('.images img').forEach(function(img) {
      img.addEventListener('click', function() {
        dialogImg.src = img.src;
        dialog.showModal();
      });
    });

    return card;
  }

  function appendEvents(events) {
    if (!events.length) return;

    var wasAtBottom = timeline.scrollHeight - timeline.scrollTop - timeline.clientHeight < 40;

    events.forEach(function(ev) {
      timeline.appendChild(createEventCard(ev));
    });

    // Auto-scroll if user was near bottom
    if (wasAtBottom) {
      timeline.scrollTop = timeline.scrollHeight;
    }

    lastTimestamp = events[events.length - 1].timestamp;
  }

  // â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function fetchEvents(since) {
    var url = '/api/activity';
    var params = [];

    // Prefer session token; fall back to raw key for initial auth
    var session = getStoredSession();
    var key = getStoredKey();
    if (session) {
      params.push('session=' + encodeURIComponent(session));
    } else if (key) {
      params.push('key=' + encodeURIComponent(key));
    }
    if (since) params.push('since=' + encodeURIComponent(since));
    if (params.length) url += '?' + params.join('&');

    return fetch(url)
      .then(function(res) {
        if (res.status === 401) {
          clearAuth();
          showKeyPrompt('Session expired. Please request a new key from the bot.');
          return { events: [] };
        }
        return res.json();
      })
      .then(function(data) {
        // If the server issued a session token (first key-based auth), store it
        if (data.sessionToken) {
          storeSession(data.sessionToken);
        }
        // Apply server default theme on first successful response if no session override
        if (!_defaultThemeApplied && data.defaultTheme) {
          _defaultThemeApplied = true;
          if (!sessionStorage.getItem('activityTheme')) {
            applyTheme(data.defaultTheme);
          }
        }
        if (data.events && data.events.length >= 0 && data.serverTime) {
          lastUpdatedEl.textContent = 'Updated ' + formatTime(data.serverTime);
        }
        return data.events || [];
      })
      .catch(function(err) {
        console.error('Activity fetch error:', err);
        lastUpdatedEl.textContent = 'Error fetching';
        return [];
      });
  }

  function poll() {
    fetchEvents(lastTimestamp).then(appendEvents);
  }

  function fullRefresh() {
    timeline.innerHTML = '';
    lastTimestamp = null;
    fetchEvents(null).then(appendEvents);
  }

  // â”€â”€ Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  dialogClose.addEventListener('click', function() { dialog.close(); });
  dialog.addEventListener('click', function(e) {
    if (e.target === dialog) dialog.close();
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  refreshBtn.addEventListener('click', fullRefresh);

  // Check for stored session or key â€” show prompt if missing
  if (!hasCredentials()) {
    showKeyPrompt(null);
  } else {
    // Initial load
    fullRefresh();

    // Start polling
    pollTimer = setInterval(poll, POLL_INTERVAL);
  }

  // â”€â”€ Future: WebSocket upgrade path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // To replace polling with real-time push:
  // 1. Add ws endpoint on outputsServer (reuse comfyuiWebSocket patterns)
  // 2. const ws = new WebSocket('ws://' + location.host + '/ws/activity');
  // 3. ws.onmessage = (e) => appendEvents([JSON.parse(e.data)]);
  // 4. Clear pollTimer when ws opens, restore on ws close.
})();
</script>
</body>
</html>
