<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot Configurator</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--surface);
    padding: 12px 24px;
    border-bottom: 2px solid var(--accent);
    display: flex;
    align-items: center;
    gap: 16px;
  }
  header h1 { font-size: 1.2em; font-weight: 600; }
  header .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--ok);
    display: inline-block;
  }
  header .dot.off { background: var(--err); }
  header .dot.warn { background: var(--warn); }
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .config-panel {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .console-panel {
    width: 360px;
    background: #0d0d1a;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .console-panel h3 {
    padding: 10px 14px;
    background: var(--surface);
    font-size: 0.85em;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
  }
  #console {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.78em;
    line-height: 1.6;
    color: var(--text-dim);
    white-space: pre-wrap;
    word-break: break-all;
  }
  #console .line { margin-bottom: 2px; }
  #console .line.err { color: var(--err); }
  #console .line.ok { color: var(--ok); }
  #console .line.warn { color: var(--warn); }

  section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  section h2 {
    font-size: 0.9em;
    padding: 10px 16px;
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  section h2::before {
    content: '▸';
    transition: transform 0.2s;
    display: inline-block;
  }
  section h2.open::before { transform: rotate(90deg); }
  section .body { padding: 16px; display: none; }
  section .body.open { display: block; }

  .field { margin-bottom: 14px; }
  .field label {
    display: block;
    font-size: 0.8em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .field label .note {
    font-style: italic;
    color: var(--accent);
    font-size: 0.9em;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 0.9em;
    font-family: inherit;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  .field input.dirty, .field textarea.dirty {
    border-color: var(--warn);
  }
  .field-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  .field-row .field { flex: 1; }
  .field-row .field.narrow { flex: 0 0 120px; }
  .field-row .field.tiny { flex: 0 0 90px; }

  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-family: inherit;
    transition: opacity 0.2s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-secondary { background: var(--accent2); color: #fff; }
  .btn-sm { padding: 5px 10px; font-size: 0.8em; }
  .btn-test { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--err); color: #fff; }

  .actions-bar {
    padding: 16px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .actions-bar .spacer { flex: 1; }
  .actions-bar .msg {
    font-size: 0.82em;
    color: var(--text-dim);
  }
  .actions-bar .msg.warn { color: var(--warn); }
  .actions-bar .msg.ok { color: var(--ok); }
  .actions-bar .msg.err { color: var(--err); }

  /* Keywords table */
  .kw-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .kw-table th {
    text-align: left;
    font-size: 0.75em;
    color: var(--text-dim);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .kw-table td { padding: 4px 8px; }
  .kw-table input, .kw-table select {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-size: 0.85em;
  }
  .kw-table .btn-sm { padding: 4px 8px; }
  .kw-table tr.kw-builtin input:not(.kw-enabled),
  .kw-table tr.kw-builtin select:not(.kw-enabled) {
    opacity: 0.6;
    pointer-events: none;
  }
  .kw-table tr.kw-builtin .kw-builtin-badge {
    font-size: 0.7em;
    color: var(--accent);
    margin-left: 4px;
    vertical-align: middle;
  }

  /* Bot control bar */
  .bot-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  .bot-controls .status-label {
    font-size: 0.85em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .bot-controls .status-label .dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block;
  }
  .bot-controls .status-label .dot.running { background: var(--ok); }
  .bot-controls .status-label .dot.stopped { background: var(--err); }
  .bot-controls .status-label .dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  .bot-controls .status-label .dot.error { background: var(--err); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .bot-controls .spacer { flex: 1; }
  .btn-ok { background: var(--ok); color: #fff; }
</style>
</head>
<body>

<header>
  <span class="dot" id="statusDot"></span>
  <h1>Bot Configurator</h1>
</header>

<div class="main">
  <div class="config-panel">

    <!-- Discord Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Discord Connection</h2>
      <div class="body open">
        <div class="field">
          <label>Client ID</label>
          <input type="text" id="discord_client_id" data-env="DISCORD_CLIENT_ID" placeholder="Discord Application Client ID">
        </div>
        <div class="field">
          <label>Bot Token <span class="note">write-only — never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="discord_token" placeholder="Paste new token to update" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testDiscord()">Test</button>
            </div>
          </div>
        </div>
        <div class="bot-controls">
          <span class="status-label">
            <span class="dot stopped" id="botDot"></span>
            <span id="botStatusText">Stopped</span>
          </span>
          <span class="spacer"></span>
          <button class="btn-ok btn-sm" id="btnStart" onclick="startBot()">▶ Start</button>
          <button class="btn-danger btn-sm" id="btnStop" onclick="stopBot()" disabled>■ Stop</button>
        </div>
      </div>
    </section>

    <!-- API Endpoints Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">API Endpoints</h2>
      <div class="body open">
        <!-- ComfyUI -->
        <div class="field-row">
          <div class="field">
            <label>ComfyUI Endpoint</label>
            <input type="text" id="comfyui_endpoint" data-env="COMFYUI_ENDPOINT" placeholder="http://localhost:8190">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('comfyui')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>ComfyUI Workflow</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Upload a ComfyUI workflow JSON file exported using <strong>"Save (API Format)"</strong> in ComfyUI.
            The workflow must contain at least one <code>%prompt%</code> placeholder (case-sensitive) which will be replaced with the Discord message prompt.
            All occurrences of <code>%prompt%</code> will be substituted.
            <br><em>Note: UI-format workflows (standard "Save") will be auto-converted, but API format is recommended for reliability.</em>
          </p>
          <div class="field-row">
            <div class="field">
              <input type="file" id="workflow_file" accept=".json" style="font-size:0.82em" onchange="handleWorkflowUpload(this)">
            </div>
          </div>
          <div id="workflowStatus" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
          <div id="customWorkflowActions" style="margin-top:6px;display:none">
            <button class="btn-sm" style="font-size:0.78em;color:#e57373;border-color:#e57373" onclick="deleteCustomWorkflow()">Remove Custom Workflow</button>
            <span style="font-size:0.75em;color:var(--text-dim);margin-left:8px">Removes uploaded workflow so the default workflow is used instead</span>
          </div>
        </div>

        <!-- Default Workflow Settings -->
        <div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <label style="display:block;font-size:0.9em;font-weight:600;margin:0">Default Workflow Settings</label>
            <button class="btn-sm" style="font-size:0.78em" onclick="discoverComfyUIOptions()">Discover Options</button>
          </div>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
            Configure a basic text-to-image workflow that will be used when no custom workflow is uploaded.
            Click <strong>Discover Options</strong> after testing the ComfyUI connection to populate dropdowns with available models, samplers, and schedulers.
          </p>
          <div id="defaultWorkflowInfo" style="font-size:0.78em;padding:6px 10px;border-radius:4px;margin-bottom:10px;display:none"></div>

          <div class="field">
            <label>Checkpoint Model</label>
            <select id="dw_model" style="width:100%">
              <option value="">— click Discover Options to load models —</option>
            </select>
          </div>

          <div class="field-row">
            <div class="field narrow">
              <label>Width</label>
              <input type="number" id="dw_width" value="512" min="64" max="4096" step="8">
            </div>
            <div class="field narrow">
              <label>Height</label>
              <input type="number" id="dw_height" value="512" min="64" max="4096" step="8">
            </div>
            <div class="field narrow">
              <label>Steps</label>
              <input type="number" id="dw_steps" value="20" min="1" max="150" step="1">
            </div>
            <div class="field narrow">
              <label>CFG</label>
              <input type="number" id="dw_cfg" value="7.0" min="0.1" max="30" step="0.5">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Sampler</label>
              <select id="dw_sampler" style="width:100%">
                <option value="euler">euler</option>
                <option value="euler_ancestral" selected>euler_ancestral</option>
                <option value="heun">heun</option>
                <option value="dpmpp_2m">dpmpp_2m</option>
                <option value="dpmpp_2m_sde">dpmpp_2m_sde</option>
                <option value="lms">lms</option>
              </select>
            </div>
            <div class="field">
              <label>Scheduler</label>
              <select id="dw_scheduler" style="width:100%">
                <option value="normal">normal</option>
                <option value="karras">karras</option>
                <option value="exponential">exponential</option>
                <option value="simple">simple</option>
                <option value="beta" selected>beta</option>
              </select>
            </div>
            <div class="field narrow">
              <label>Denoise</label>
              <input type="number" id="dw_denoise" value="0.88" min="0" max="1" step="0.01">
            </div>
          </div>

          <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
            <button class="btn-sm" onclick="saveDefaultWorkflow()">Save Default Workflow</button>
            <span id="dwSaveStatus" style="font-size:0.8em;color:var(--text-dim)"></span>
          </div>
        </div>

        <!-- Test Image Generation -->
        <div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <label style="display:block;font-size:0.8em;color:var(--text-dim);margin-bottom:6px">Test Image Generation <span class="note">submit a prompt directly to ComfyUI</span></label>
          <div class="field-row" style="margin-bottom:8px">
            <div class="field">
              <input type="text" id="testPrompt" value="a picture of a banana" placeholder="Enter a test prompt…">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" id="btnTestGenerate" onclick="testGenerateImage()">Generate</button>
            </div>
          </div>
          <div id="testGenStatus" style="font-size:0.8em;color:var(--text-dim);display:none"></div>
          <div id="testGenResults" style="margin-top:8px;display:none">
            <div id="testGenImages" style="display:flex;flex-wrap:wrap;gap:10px"></div>
          </div>
        </div>

        <hr style="border-color:var(--border);margin:16px 0">

        <!-- Ollama -->
        <div class="field-row">
          <div class="field">
            <label>Ollama Endpoint</label>
            <input type="text" id="ollama_endpoint" data-env="OLLAMA_ENDPOINT" placeholder="http://localhost:11434">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('ollama')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>Ollama Model</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Select a model from the Ollama instance. Click <strong>Test</strong> above to refresh the model list.
          </p>
          <select id="ollama_model" data-env="OLLAMA_MODEL" onchange="markDirty()">
            <option value="">— click Test to load models —</option>
          </select>
        </div>
        <div class="field">
          <label>
            System Prompt
            <span class="note">sets the bot's personality for all Ollama responses</span>
            <button class="btn-sm" style="margin-left:8px;font-size:0.85em;vertical-align:middle" onclick="resetSystemPrompt()">Reset to Default</button>
          </label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            This prompt is sent with every Ollama request to set context and personality. Leave empty to use raw model behavior with no system context.
          </p>
          <textarea id="ollama_system_prompt" data-env="OLLAMA_SYSTEM_PROMPT" rows="4" style="width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.9em;font-family:inherit;resize:vertical" placeholder="You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate—if someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful."></textarea>
        </div>
        <hr style="border-color:var(--border);margin:16px 0">
        <div class="field">
          <label>
            Final Pass Model
            <span class="note">used when Final Pass is enabled on a keyword — falls back to default model above</span>
          </label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            When a keyword has <strong>Final Pass</strong> checked, the API result is refined through Ollama using this model.
            Click <strong>Test</strong> above to populate the model list. Leave empty to use the default Ollama model.
          </p>
          <select id="ollama_final_pass_model" data-env="OLLAMA_FINAL_PASS_MODEL" onchange="markDirty()">
            <option value="">— use default model —</option>
          </select>
        </div>
        <div class="field narrow">
          <label title="When enabled, the full abilities context sent to Ollama is logged in the status console">Detailed Ability Logging ℹ️</label>
          <select id="ability_logging_detailed" data-env="ABILITY_LOGGING_DETAILED" onchange="markDirty()">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
      </div>
    </section>

    <!-- AccuWeather Section -->
    <section>
      <h2 onclick="toggleSection(this)">AccuWeather API</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Get a free API key at <a href="https://developer.accuweather.com" target="_blank" style="color:var(--accent)">developer.accuweather.com</a>.
          The AccuWeather API provides current conditions and 5-day forecasts. Configure a default location so users can ask for weather without specifying a city.
        </p>
        <div class="field">
          <label>API Key <span class="note">write-only — never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="accuweather_api_key" placeholder="Paste AccuWeather API key" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testConnection('accuweather')">Test</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Default Location <span class="note">city name or zip code used when user doesn't specify</span></label>
          <input type="text" id="accuweather_default_location" data-env="ACCUWEATHER_DEFAULT_LOCATION" placeholder="e.g. New York, 90210, or 349727">
        </div>
        <div class="field">
          <label>Endpoint <span class="note">override only if using a proxy</span></label>
          <input type="text" id="accuweather_endpoint" data-env="ACCUWEATHER_ENDPOINT" placeholder="https://dataservice.accuweather.com">
        </div>
        <div id="accuweatherTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- NFL Section -->
    <section>
      <h2 onclick="toggleSection(this)">NFL API (ESPN)</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Powered by ESPN's public API — no API key required.
          Provides live scores, schedules, Super Bowl data, and news. Use keywords like <code style="color:var(--accent)">nfl scores</code>, <code style="color:var(--accent)">nfl score &lt;team&gt;</code>, <code style="color:var(--accent)">superbowl</code>, <code style="color:var(--accent)">superbowl report</code>, <code style="color:var(--accent)">nfl news</code>, or <code style="color:var(--accent)">nfl news report</code>.
        </p>
        <div class="field">
          <label>Enabled</label>
          <select id="nfl_enabled" data-env="NFL_ENABLED">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
        <div class="field">
          <label>Endpoint <span class="note">override only if using a proxy</span></label>
          <input type="text" id="nfl_endpoint" data-env="NFL_BASE_URL" placeholder="https://site.api.espn.com/apis/site/v2/sports/football/nfl">
        </div>
        <div class="field narrow">
          <label title="Controls how much NFL API detail is written to logs. 0 = summary only, 1 = summary + trimmed preview, 2 = full payload">Logging Level ℹ️</label>
          <select id="nfl_logging_level" data-env="NFL_LOGGING_LEVEL" onchange="markDirty()">
            <option value="0">0 — Summary</option>
            <option value="1">1 — Preview</option>
            <option value="2">2 — Full</option>
          </select>
        </div>
        <div class="field">
          <label>Super Bowl Report Prompt <span class="note">AI instruction for the <code style="color:var(--accent)">superbowl report</code> keyword</span></label>
          <textarea id="nfl_superbowl_report_prompt" data-env="NFL_SUPERBOWL_REPORT_PROMPT" rows="3" placeholder="Provide an intelligent, comprehensive assessment of the current Super Bowl based on the data above. Include context from the news articles to enrich the analysis. Be insightful and conversational."></textarea>
          <button type="button" class="btn small" onclick="document.getElementById('nfl_superbowl_report_prompt').value='';markDirty();" title="Clear to use default prompt">Reset to Default</button>
        </div>
        <div id="nflTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- Error Handling Section -->
    <section>
      <h2 onclick="toggleSection(this)">Error Handling</h2>
      <div class="body">
        <div class="field">
          <label>Error Message <span class="note">sent to Discord users when an error occurs</span></label>
          <input type="text" id="error_message" data-env="ERROR_MESSAGE" placeholder="I'm experiencing technical difficulties. Please try again later.">
        </div>
        <div class="field narrow">
          <label>Error Rate Limit (minutes) <span class="note">minimum time between error messages</span></label>
          <input type="number" id="error_rate_limit" data-env="ERROR_RATE_LIMIT_MINUTES" placeholder="60" min="1">
        </div>
      </div>
    </section>

    <!-- HTTP Server Section -->
    <section>
      <h2 onclick="toggleSection(this)">HTTP Server</h2>
      <div class="body">
        <div class="field-row">
          <div class="field narrow">
            <label>Port <span class="note">restart</span></label>
            <input type="number" id="http_port" data-env="HTTP_PORT" placeholder="3000">
          </div>
          <div class="field">
            <label>Output Base URL</label>
            <input type="text" id="output_base_url" data-env="OUTPUT_BASE_URL" placeholder="http://localhost:3000">
          </div>
        </div>
      </div>
    </section>

    <!-- Limits Section -->
    <section>
      <h2 onclick="toggleSection(this)">Limits</h2>
      <div class="body">
        <div class="field-row">
          <div class="field">
            <label>File Size Threshold (bytes)</label>
            <input type="number" id="file_size_threshold" data-env="FILE_SIZE_THRESHOLD" placeholder="10485760">
          </div>
          <div class="field narrow">
            <label>Default Timeout (sec)</label>
            <input type="number" id="default_timeout" data-env="DEFAULT_TIMEOUT" placeholder="300">
          </div>
        </div>
        <div class="field narrow">
          <label>Max Attachments per Message <span class="note">1–10, Discord limit is 10</span></label>
          <input type="number" id="max_attachments" data-env="MAX_ATTACHMENTS" placeholder="10" min="1" max="10">
        </div>
        <div class="field narrow">
          <label>Include Embed in Image Responses <span class="note">Shows internal View link; off by default</span></label>
          <select id="image_response_include_embed" data-env="IMAGE_RESPONSE_INCLUDE_EMBED" onchange="markDirty()">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
    </section>
    <!-- Reply Chain Section -->
    <section>
      <h2 onclick="toggleSection(this)">Reply Chain Context</h2>
      <div class="body">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          When enabled, the bot collects conversation history for Ollama. In servers, this traverses reply chains.
          In <strong>DMs</strong>, recent messages are included automatically without requiring explicit replies.
        </p>
        <div class="field-row">
          <div class="field narrow">
            <label>Enabled</label>
            <select id="reply_chain_enabled" data-env="REPLY_CHAIN_ENABLED" onchange="markDirty()">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field narrow">
            <label>Max Depth <span class="note">1–50 messages</span></label>
            <input type="number" id="reply_chain_max_depth" data-env="REPLY_CHAIN_MAX_DEPTH" placeholder="10" min="1" max="50">
          </div>
          <div class="field narrow">
            <label>Max Tokens <span class="note">1,000–128,000 chars</span></label>
            <input type="number" id="reply_chain_max_tokens" data-env="REPLY_CHAIN_MAX_TOKENS" placeholder="16000" min="1000" max="128000">
          </div>
        </div>
      </div>
    </section>
    <!-- Keywords Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Keywords → API Routing</h2>
      <div class="body open">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          Map @mention keywords to APIs. When <strong>Ability</strong> is checked, the keyword's description is included
          as context so Ollama can suggest using that API even when the keyword isn't typed explicitly.
          <strong>Final Pass</strong> sends the API result back through Ollama for conversational refinement.
        </p>
        <table class="kw-table">
          <thead>
            <tr>
              <th style="text-align:center" title="Enable or disable this keyword">On</th>
              <th>Keyword</th>
              <th>API</th>
              <th title="Request timeout in seconds">Timeout (s)</th>
              <th title="Human-readable description; used as ability context when Ability is checked">Description</th>
              <th title="When checked, this keyword's description is included in Ollama's abilities context so it can suggest using this API without the keyword being typed" style="text-align:center">Ability ℹ️</th>
              <th title="When checked, the API result is passed through Ollama for conversational refinement using the global Final Pass Model" style="text-align:center">Final Pass ℹ️</th>
              <th title="When checked, Ollama evaluates context relevance before including reply-chain history (with min/max depth controls)" style="text-align:center">Context Filter ℹ️</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="kwBody"></tbody>
        </table>
        <div style="margin-top:10px">
          <button class="btn-secondary btn-sm" onclick="addKeywordRow()">+ Add Keyword</button>
        </div>
      </div>
    </section>

  </div>

  <!-- Console Panel -->
  <div class="console-panel">
    <h3>Status Console</h3>
    <div id="console"></div>
  </div>
</div>

<!-- Bottom action bar -->
<div class="actions-bar">
  <button class="btn-secondary btn-sm" onclick="loadConfig()">↻ Reload</button>
  <span class="spacer"></span>
  <span class="msg" id="saveMsg"></span>
  <button class="btn-primary" id="saveBtn" disabled onclick="saveConfig()">Save Changes</button>
</div>

<script>
  // ── State ──────────────────────────────────────────
  let originalConfig = null;
  let dirty = false;

  // ── Section toggle ─────────────────────────────────
  function toggleSection(h2) {
    h2.classList.toggle('open');
    h2.nextElementSibling.classList.toggle('open');
  }

  // ── Console ────────────────────────────────────────
  const consoleEl = document.getElementById('console');

  function conLog(text, cls = '') {
    const d = document.createElement('div');
    d.className = 'line' + (cls ? ' ' + cls : '');
    d.textContent = text;
    consoleEl.appendChild(d);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  async function pollStatus() {
    try {
      const res = await fetch('/api/config/status');
      const data = await res.json();
      consoleEl.innerHTML = '';
      for (const line of data.lines) {
        // Classify by structured log level tags, with keyword highlights for info
        const cls = line.includes('[error]') ? 'err'
          : line.includes('[warn]') ? 'warn'
          : (line.includes(' OK') || line.includes('started') || line.includes('logged in') || line.includes('saved') || line.includes('Authenticated') || line.includes('Loaded ')) ? 'ok'
          : '';
        conLog(line, cls);
      }
    } catch (e) {
      // server not reachable
    }
  }

  // ── Bot status polling ─────────────────────────────
  async function pollBotStatus() {
    try {
      const res = await fetch('/api/discord/status');
      const data = await res.json();
      updateBotUI(data);
    } catch (e) {
      updateBotUI({ status: 'stopped', username: null, error: null, tokenConfigured: false });
    }
  }

  function updateBotUI(data) {
    const dot = document.getElementById('botDot');
    const text = document.getElementById('botStatusText');
    const headerDot = document.getElementById('statusDot');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');

    dot.className = 'dot ' + data.status;

    switch (data.status) {
      case 'running':
        text.textContent = `Connected as ${data.username || '?'}`;
        headerDot.className = 'dot';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'connecting':
        text.textContent = 'Connecting…';
        headerDot.className = 'dot warn';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'error':
        text.textContent = `Error: ${data.error || 'unknown'}`;
        headerDot.className = 'dot off';
        btnStart.disabled = false;
        btnStop.disabled = true;
        break;
      default:
        text.textContent = data.tokenConfigured ? 'Stopped' : 'Stopped — no token configured';
        headerDot.className = 'dot off';
        btnStart.disabled = !data.tokenConfigured;
        btnStop.disabled = true;
    }
  }

  // ── Dirty tracking ─────────────────────────────────
  function markDirty() {
    dirty = true;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('saveMsg').textContent = 'Unsaved changes';
    document.getElementById('saveMsg').className = 'msg warn';
  }

  function markClean() {
    dirty = false;
    document.getElementById('saveBtn').disabled = true;
  }

  // Attach to all env inputs + token field
  function attachDirtyListeners() {
    document.querySelectorAll('[data-env]').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.add('dirty');
        markDirty();
      });
    });
    document.getElementById('discord_token').addEventListener('input', () => {
      if (document.getElementById('discord_token').value.trim()) {
        markDirty();
      }
    });
  }

  // ── System prompt reset ────────────────────────────
  const DEFAULT_SYSTEM_PROMPT = "You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate\u2014if someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful.";

  function resetSystemPrompt() {
    const el = document.getElementById('ollama_system_prompt');
    el.value = DEFAULT_SYSTEM_PROMPT;
    el.classList.add('dirty');
    markDirty();
  }

  // ── Load config ────────────────────────────────────
  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const cfg = await res.json();
      originalConfig = cfg;

      // Populate env fields
      document.getElementById('discord_client_id').value = cfg.discord.clientId;
      document.getElementById('comfyui_endpoint').value = cfg.apis.comfyui;
      document.getElementById('ollama_endpoint').value = cfg.apis.ollama;
      document.getElementById('http_port').value = cfg.http.port;
      document.getElementById('output_base_url').value = cfg.http.outputBaseUrl;
      document.getElementById('file_size_threshold').value = cfg.limits.fileSizeThreshold;
      document.getElementById('default_timeout').value = cfg.limits.defaultTimeout;
      document.getElementById('max_attachments').value = cfg.limits.maxAttachments;

      // Populate Ollama model (saved selection)
      const modelSelect = document.getElementById('ollama_model');
      if (cfg.apis.ollamaModel) {
        // Ensure the saved model is in the dropdown
        const exists = Array.from(modelSelect.options).some(o => o.value === cfg.apis.ollamaModel);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = cfg.apis.ollamaModel;
          opt.textContent = cfg.apis.ollamaModel + ' (saved)';
          modelSelect.appendChild(opt);
        }
        modelSelect.value = cfg.apis.ollamaModel;
      }

      // Populate ComfyUI workflow status
      const workflowStatus = document.getElementById('workflowStatus');
      _hasCustomWorkflow = !!cfg.apis.comfyuiWorkflowConfigured;
      if (_hasCustomWorkflow) {
        workflowStatus.innerHTML = '<span style="color:var(--ok)">✓ Workflow configured</span>';
        document.getElementById('customWorkflowActions').style.display = '';
      } else {
        workflowStatus.innerHTML = '<span style="color:var(--text-dim)">No workflow uploaded</span>';
        document.getElementById('customWorkflowActions').style.display = 'none';
      }

      // Populate default workflow settings
      if (cfg.defaultWorkflow) {
        const dw = cfg.defaultWorkflow;
        if (dw.model) {
          const modelSelect = document.getElementById('dw_model');
          const exists = Array.from(modelSelect.options).some(o => o.value === dw.model);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.model;
            opt.textContent = dw.model + ' (saved)';
            modelSelect.appendChild(opt);
          }
          modelSelect.value = dw.model;
        }
        document.getElementById('dw_width').value = dw.width || 512;
        document.getElementById('dw_height').value = dw.height || 512;
        document.getElementById('dw_steps').value = dw.steps || 20;
        document.getElementById('dw_cfg').value = dw.cfg || 7.0;
        if (dw.sampler) {
          const samplerSelect = document.getElementById('dw_sampler');
          const exists = Array.from(samplerSelect.options).some(o => o.value === dw.sampler);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.sampler;
            opt.textContent = dw.sampler;
            samplerSelect.appendChild(opt);
          }
          samplerSelect.value = dw.sampler;
        }
        if (dw.scheduler) {
          const schedulerSelect = document.getElementById('dw_scheduler');
          const exists = Array.from(schedulerSelect.options).some(o => o.value === dw.scheduler);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.scheduler;
            opt.textContent = dw.scheduler;
            schedulerSelect.appendChild(opt);
          }
          schedulerSelect.value = dw.scheduler;
        }
        document.getElementById('dw_denoise').value = typeof dw.denoise === 'number' ? dw.denoise : 1.0;
      }
      updateDefaultWorkflowInfo();

      // Populate Ollama system prompt
      const systemPromptEl = document.getElementById('ollama_system_prompt');
      if (cfg.apis.ollamaSystemPrompt) {
        systemPromptEl.value = cfg.apis.ollamaSystemPrompt;
      }

      // Populate AccuWeather fields
      document.getElementById('accuweather_default_location').value = cfg.apis.accuweatherDefaultLocation || '';
      document.getElementById('accuweather_endpoint').value = cfg.apis.accuweather || '';
      document.getElementById('accuweather_api_key').value = '';
      document.getElementById('accuweather_api_key').placeholder =
        cfg.apis.accuweatherApiKeyConfigured ? 'API key configured ✓ — paste new value to change' : 'Paste AccuWeather API key';

      // Populate NFL fields
      document.getElementById('nfl_enabled').value = cfg.apis.nflEnabled ? 'true' : 'false';
      document.getElementById('nfl_endpoint').value = cfg.apis.nfl || '';

      // Populate NFL logging level
      const nflLogLevel = document.getElementById('nfl_logging_level');
      nflLogLevel.value = String(cfg.nflLogging?.level ?? 1);

      // Populate Super Bowl report prompt
      document.getElementById('nfl_superbowl_report_prompt').value = cfg.apis.nflSuperBowlReportPrompt || '';

      // Populate error handling fields
      document.getElementById('error_message').value = cfg.errorHandling?.errorMessage || '';
      document.getElementById('error_rate_limit').value = cfg.errorHandling?.errorRateLimitMinutes || 60;

      // Populate reply chain fields
      const rcEnabled = document.getElementById('reply_chain_enabled');
      rcEnabled.value = cfg.replyChain?.enabled === false ? 'false' : 'true';
      document.getElementById('reply_chain_max_depth').value = cfg.replyChain?.maxDepth || 10;
      document.getElementById('reply_chain_max_tokens').value = cfg.replyChain?.maxTokens || 16000;

      // Populate ability logging
      const alDetailed = document.getElementById('ability_logging_detailed');
      alDetailed.value = cfg.abilityLogging?.detailed ? 'true' : 'false';

      // Populate Final Pass Model (saved selection)
      const fpModelSelect = document.getElementById('ollama_final_pass_model');
      if (cfg.apis.ollamaFinalPassModel && cfg.apis.ollamaFinalPassModel !== cfg.apis.ollamaModel) {
        const exists = Array.from(fpModelSelect.options).some(o => o.value === cfg.apis.ollamaFinalPassModel);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = cfg.apis.ollamaFinalPassModel;
          opt.textContent = cfg.apis.ollamaFinalPassModel + ' (saved)';
          fpModelSelect.appendChild(opt);
        }
        fpModelSelect.value = cfg.apis.ollamaFinalPassModel;
      }

      // Populate image response setting
      const irEmbed = document.getElementById('image_response_include_embed');
      irEmbed.value = cfg.imageResponse?.includeEmbed ? 'true' : 'false';

      // Token field is always empty (write-only) — just show placeholder
      document.getElementById('discord_token').value = '';
      document.getElementById('discord_token').placeholder =
        cfg.discord.tokenConfigured ? 'Token configured ✓ — paste new value to change' : 'Paste Discord bot token here';

      // Populate keywords
      renderKeywords(cfg.keywords);

      // Clear dirty state
      document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
      markClean();
      document.getElementById('saveMsg').textContent = 'Config loaded';
      document.getElementById('saveMsg').className = 'msg ok';
      document.getElementById('statusDot').className = 'dot';

      conLog(`[${new Date().toISOString()}] Config loaded from server`, 'ok');
    } catch (e) {
      document.getElementById('statusDot').className = 'dot off';
      conLog(`[${new Date().toISOString()}] Failed to load config: ${e.message}`, 'err');
    }
  }

  // ── Keywords table ─────────────────────────────────
  function renderKeywords(keywords) {
    const tbody = document.getElementById('kwBody');
    tbody.innerHTML = '';
    for (const kw of keywords) {
      addKeywordRow(kw);
    }
  }

  function addKeywordRow(kw = null) {
    const tbody = document.getElementById('kwBody');
    const tr = document.createElement('tr');
    const isBuiltin = !!kw?.builtin;
    const isEnabled = kw ? kw.enabled !== false : true;
    if (isBuiltin) tr.classList.add('kw-builtin');
    tr.dataset.builtin = isBuiltin ? '1' : '';
    tr.innerHTML = `
      <td style="text-align:center"><input type="checkbox" class="kw-enabled" ${isEnabled ? 'checked' : ''} title="${isBuiltin ? 'Enable or disable this built-in keyword' : 'Enable or disable this keyword'}"></td>
      <td><input type="text" class="kw-keyword" value="${esc(kw?.keyword || '')}" placeholder="keyword">${isBuiltin ? '<span class="kw-builtin-badge">built-in</span>' : ''}</td>
      <td><select class="kw-api">
        <option value="comfyui" ${kw?.api === 'comfyui' ? 'selected' : ''}>comfyui</option>
        <option value="ollama" ${kw?.api === 'ollama' ? 'selected' : ''}>ollama</option>
        <option value="accuweather" ${kw?.api === 'accuweather' ? 'selected' : ''}>accuweather</option>
        <option value="nfl" ${kw?.api === 'nfl' ? 'selected' : ''}>nfl</option>
      </select></td>
      <td><input type="number" class="kw-timeout" value="${kw?.timeout || 300}" style="width:70px"></td>
      <td><input type="text" class="kw-desc" value="${esc(kw?.description || '')}" placeholder="description"></td>
      <td style="text-align:center"><input type="checkbox" class="kw-ability" ${kw?.abilityText ? 'checked' : ''} title="Include this keyword as an ability in Ollama context"></td>
      <td style="text-align:center"><input type="checkbox" class="kw-finalPass" ${kw?.finalOllamaPass ? 'checked' : ''} title="Pass API result through Ollama for conversational refinement"></td>
      <td style="text-align:center">
        <input type="checkbox" class="kw-ctxFilter" ${kw?.contextFilterEnabled ? 'checked' : ''} onchange="toggleCtxDepth(this)" title="Evaluate context relevance before including reply-chain history">
        <span class="kw-ctx-depth" style="display:${kw?.contextFilterEnabled ? 'inline' : 'none'}">
          <input type="number" class="kw-ctxMin" value="${kw?.contextFilterMinDepth ?? 1}" min="1" style="width:50px" title="Min depth (always included)">–<input type="number" class="kw-ctxMax" value="${kw?.contextFilterMaxDepth ?? ''}" min="1" style="width:50px" title="Max depth" placeholder="auto">
        </span>
      </td>
      <td>${isBuiltin ? '' : '<button class="btn-danger btn-sm" onclick="this.closest(\'tr\').remove();markDirty()">✕</button>'}</td>
    `;
    // Attach dirty listeners to new row inputs
    tr.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', markDirty);
      el.addEventListener('change', markDirty);
    });
    tbody.appendChild(tr);
  }

  function toggleCtxDepth(checkbox) {
    const depthSpan = checkbox.closest('td').querySelector('.kw-ctx-depth');
    depthSpan.style.display = checkbox.checked ? 'inline' : 'none';
    markDirty();
  }

  function collectKeywords() {
    const rows = document.querySelectorAll('#kwBody tr');
    const keywords = [];
    for (const row of rows) {
      const keyword = row.querySelector('.kw-keyword').value.trim();
      if (!keyword) continue;
      const isBuiltin = row.dataset.builtin === '1';
      const isEnabled = row.querySelector('.kw-enabled').checked;
      const entry = {
        keyword,
        api: row.querySelector('.kw-api').value,
        timeout: parseInt(row.querySelector('.kw-timeout').value, 10) || 300,
        description: row.querySelector('.kw-desc').value.trim() || keyword,
      };
      const isAbility = row.querySelector('.kw-ability').checked;
      if (isAbility) entry.abilityText = entry.description;
      const finalPass = row.querySelector('.kw-finalPass').checked;
      if (finalPass) entry.finalOllamaPass = true;
      const ctxFilter = row.querySelector('.kw-ctxFilter').checked;
      if (ctxFilter) {
        entry.contextFilterEnabled = true;
        const minD = parseInt(row.querySelector('.kw-ctxMin').value, 10);
        const maxD = parseInt(row.querySelector('.kw-ctxMax').value, 10);
        if (!isNaN(minD) && minD >= 1) entry.contextFilterMinDepth = minD;
        if (!isNaN(maxD) && maxD >= 0) entry.contextFilterMaxDepth = maxD;
      }
      if (isBuiltin) entry.builtin = true;
      if (!isEnabled) entry.enabled = false;
      keywords.push(entry);
    }
    return keywords;
  }

  // ── Save ───────────────────────────────────────────
  async function saveConfig() {
    const saveBtn = document.getElementById('saveBtn');
    const saveMsg = document.getElementById('saveMsg');
    saveBtn.disabled = true;
    saveMsg.textContent = 'Saving…';
    saveMsg.className = 'msg';

    try {
      // Collect env changes — include empty values so users can clear fields
      const env = {};
      document.querySelectorAll('[data-env]').forEach(input => {
        const key = input.dataset.env;
        // Skip DISCORD_TOKEN here — handled specially below
        if (key === 'DISCORD_TOKEN') return;
        env[key] = input.value.trim();
      });

      // Include token only if user typed a new value (write-only field)
      const tokenInput = document.getElementById('discord_token');
      const tokenVal = tokenInput.value.trim();
      if (tokenVal) {
        env['DISCORD_TOKEN'] = tokenVal;
      }

      // Include AccuWeather API key only if user typed a new value (write-only field)
      const awKeyInput = document.getElementById('accuweather_api_key');
      const awKeyVal = awKeyInput.value.trim();
      if (awKeyVal) {
        env['ACCUWEATHER_API_KEY'] = awKeyVal;
      }

      // Collect keywords
      const keywords = collectKeywords();

      const res = await fetch('/api/config/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ env, keywords }),
      });

      const result = await res.json();

      if (result.success) {
        document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
        markClean();
        // Clear the token input after successful save
        tokenInput.value = '';
        tokenInput.placeholder = 'Token configured ✓ — paste new value to change';
        // Clear the AccuWeather API key input after successful save
        if (awKeyVal) {
          awKeyInput.value = '';
          awKeyInput.placeholder = 'API key configured ✓ — paste new value to change';
        }
        saveMsg.textContent = result.messages.join(' | ');
        saveMsg.className = 'msg ok';
        conLog(`[${new Date().toISOString()}] Save successful`, 'ok');
        for (const m of result.messages) {
          conLog(`  ${m}`, m.includes('⚠') ? 'warn' : 'ok');
        }
        // Refresh status
        await pollStatus();
        await pollBotStatus();
      } else {
        saveMsg.textContent = result.error;
        saveMsg.className = 'msg err';
        saveBtn.disabled = false;
        conLog(`[${new Date().toISOString()}] Save failed: ${result.error}`, 'err');
      }
    } catch (e) {
      saveMsg.textContent = `Error: ${e.message}`;
      saveMsg.className = 'msg err';
      saveBtn.disabled = false;
      conLog(`[${new Date().toISOString()}] Save error: ${e.message}`, 'err');
    }
  }

  // ── Test connection ────────────────────────────────
  async function testConnection(api) {
    conLog(`[${new Date().toISOString()}] Testing ${api} connection…`);
    try {
      const res = await fetch(`/api/config/test-connection/${api}`);
      const data = await res.json();
      if (data.healthy) {
        conLog(`  ✓ ${api} at ${data.endpoint} is reachable`, 'ok');

        // For Ollama, populate model dropdown from returned models
        if (api === 'ollama' && data.models && data.models.length > 0) {
          const modelSelect = document.getElementById('ollama_model');
          const currentValue = modelSelect.value;
          modelSelect.innerHTML = '';

          // Add default empty option
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = '— select a model —';
          modelSelect.appendChild(defaultOpt);

          // Add each model
          for (const model of data.models) {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = `${model.name} (${model.parameterSize}, ${model.family}, ${model.quantization})`;
            modelSelect.appendChild(opt);
          }

          // Restore previous selection if it still exists
          if (currentValue) {
            const exists = Array.from(modelSelect.options).some(o => o.value === currentValue);
            if (exists) {
              modelSelect.value = currentValue;
            }
          }

          // Also populate the Final Pass Model dropdown
          const fpModelSelect = document.getElementById('ollama_final_pass_model');
          const fpCurrentValue = fpModelSelect.value;
          fpModelSelect.innerHTML = '';
          const fpDefaultOpt = document.createElement('option');
          fpDefaultOpt.value = '';
          fpDefaultOpt.textContent = '— use default model —';
          fpModelSelect.appendChild(fpDefaultOpt);
          for (const model of data.models) {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = `${model.name} (${model.parameterSize}, ${model.family}, ${model.quantization})`;
            fpModelSelect.appendChild(opt);
          }
          if (fpCurrentValue) {
            const exists = Array.from(fpModelSelect.options).some(o => o.value === fpCurrentValue);
            if (exists) fpModelSelect.value = fpCurrentValue;
          }

          conLog(`  ✓ Found ${data.models.length} model(s)`, 'ok');
          for (const m of data.models) {
            conLog(`    • ${m.name} (${m.parameterSize}, ${m.family})`);
          }
        }

        // For AccuWeather, show resolved location info
        if (api === 'accuweather') {
          const resultEl = document.getElementById('accuweatherTestResult');
          if (data.location) {
            const loc = data.location;
            resultEl.innerHTML = `<span style="color:var(--ok)">✓ API key valid. Default location: ${loc.LocalizedName}, ${loc.AdministrativeArea?.ID || ''}, ${loc.Country?.LocalizedName || ''} (key: ${loc.Key})</span>`;
            conLog(`  ✓ Default location resolved: ${loc.LocalizedName}, ${loc.AdministrativeArea?.ID || ''}`, 'ok');
          } else {
            resultEl.innerHTML = '<span style="color:var(--ok)">✓ API key valid. No default location configured.</span>';
          }
        }

        // For NFL, show success status
        if (api === 'nfl') {
          const resultEl = document.getElementById('nflTestResult');
          resultEl.innerHTML = '<span style="color:var(--ok)">✓ API key valid. NFL data available.</span>';
        }
      } else {
        conLog(`  ✗ ${api} at ${data.endpoint} is not reachable`, 'err');
        if (data.error) conLog(`    ${data.error}`, 'err');

        if (api === 'accuweather') {
          const resultEl = document.getElementById('accuweatherTestResult');
          resultEl.innerHTML = `<span style="color:var(--err)">✗ ${data.error || 'Connection failed'}</span>`;
        }
        if (api === 'nfl') {
          const resultEl = document.getElementById('nflTestResult');
          resultEl.innerHTML = `<span style="color:var(--err)">✗ ${data.error || 'Connection failed'}</span>`;
        }
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ✗ Test failed: ${e.message}`, 'err');
    }
  }

  // ── Discord controls ──────────────────────────────
  async function testDiscord() {
    const token = document.getElementById('discord_token').value.trim();
    if (!token) {
      conLog(`[${new Date().toISOString()}] Enter a token to test`, 'warn');
      return;
    }
    conLog(`[${new Date().toISOString()}] Testing Discord token…`);
    try {
      const res = await fetch('/api/discord/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });
      const data = await res.json();
      if (data.success) {
        conLog(`  ✓ ${data.message}`, 'ok');
      } else {
        conLog(`  ✗ ${data.message}`, 'err');
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ✗ Test failed: ${e.message}`, 'err');
    }
  }

  async function startBot() {
    conLog(`[${new Date().toISOString()}] Starting Discord bot…`);
    document.getElementById('btnStart').disabled = true;
    try {
      const res = await fetch('/api/discord/start', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '✓' : '✗'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      // Poll bot status a few times to catch the ready event
      for (let i = 0; i < 5; i++) {
        await new Promise(r => setTimeout(r, 1000));
        await pollBotStatus();
      }
    } catch (e) {
      conLog(`  ✗ Start failed: ${e.message}`, 'err');
      document.getElementById('btnStart').disabled = false;
    }
  }

  async function stopBot() {
    conLog(`[${new Date().toISOString()}] Stopping Discord bot…`);
    document.getElementById('btnStop').disabled = true;
    try {
      const res = await fetch('/api/discord/stop', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '✓' : '✗'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      await pollBotStatus();
    } catch (e) {
      conLog(`  ✗ Stop failed: ${e.message}`, 'err');
      document.getElementById('btnStop').disabled = false;
    }
  }

  // ── Workflow upload ─────────────────────────────────
  async function handleWorkflowUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const statusEl = document.getElementById('workflowStatus');
    statusEl.innerHTML = '<span style="color:var(--warn)">Uploading…</span>';
    conLog(`[${new Date().toISOString()}] Uploading workflow: ${file.name}…`);

    try {
      const text = await file.text();

      const res = await fetch('/api/config/upload-workflow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workflow: text, filename: file.name }),
      });

      const data = await res.json();

      if (data.success) {
        const convertedNote = data.converted ? ' [auto-converted from UI format]' : '';
        statusEl.innerHTML = `<span style="color:var(--ok)">✓ ${esc(file.name)} — validation passed${convertedNote}</span>`;
        conLog(`  ✓ Workflow "${file.name}" uploaded and validated${convertedNote}`, 'ok');
        if (data.converted) {
          conLog('  ℹ Workflow was in ComfyUI UI format and auto-converted to API format. For best results, export using "Save (API Format)" in ComfyUI.', 'warn');
        }
        _hasCustomWorkflow = true;
        document.getElementById('customWorkflowActions').style.display = '';
        updateDefaultWorkflowInfo();
      } else {
        statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(file.name)} — ${esc(data.error)}</span>`;
        conLog(`  ✗ Workflow validation failed: ${data.error}`, 'err');
      }

      await pollStatus();
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">✗ Upload failed: ${esc(e.message)}</span>`;
      conLog(`  ✗ Workflow upload failed: ${e.message}`, 'err');
    }

    // Reset the file input so the same file can be re-uploaded
    input.value = '';
  }

  // ── Default workflow management ─────────────────────
  async function discoverComfyUIOptions() {
    conLog(`[${new Date().toISOString()}] Discovering ComfyUI options…`);
    try {
      const [samplersRes, schedulersRes, checkpointsRes] = await Promise.all([
        fetch('/api/config/comfyui/samplers'),
        fetch('/api/config/comfyui/schedulers'),
        fetch('/api/config/comfyui/checkpoints'),
      ]);

      const samplers = await samplersRes.json();
      const schedulers = await schedulersRes.json();
      const checkpoints = await checkpointsRes.json();

      // Populate sampler dropdown
      if (Array.isArray(samplers) && samplers.length > 0) {
        const samplerSelect = document.getElementById('dw_sampler');
        const currentSampler = samplerSelect.value;
        samplerSelect.innerHTML = '';
        for (const s of samplers) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          samplerSelect.appendChild(opt);
        }
        if (samplers.includes(currentSampler)) samplerSelect.value = currentSampler;
        conLog(`  ✓ Found ${samplers.length} sampler(s)`, 'ok');
      } else {
        conLog('  ⚠ No samplers returned — using defaults', 'warn');
      }

      // Populate scheduler dropdown
      if (Array.isArray(schedulers) && schedulers.length > 0) {
        const schedulerSelect = document.getElementById('dw_scheduler');
        const currentScheduler = schedulerSelect.value;
        schedulerSelect.innerHTML = '';
        for (const s of schedulers) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          schedulerSelect.appendChild(opt);
        }
        if (schedulers.includes(currentScheduler)) schedulerSelect.value = currentScheduler;
        conLog(`  ✓ Found ${schedulers.length} scheduler(s)`, 'ok');
      } else {
        conLog('  ⚠ No schedulers returned — using defaults', 'warn');
      }

      // Populate checkpoint dropdown
      if (Array.isArray(checkpoints) && checkpoints.length > 0) {
        const modelSelect = document.getElementById('dw_model');
        const currentModel = modelSelect.value;
        modelSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '— select a checkpoint —';
        modelSelect.appendChild(defaultOpt);
        for (const c of checkpoints) {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          modelSelect.appendChild(opt);
        }
        if (currentModel && checkpoints.includes(currentModel)) modelSelect.value = currentModel;
        conLog(`  ✓ Found ${checkpoints.length} checkpoint(s)`, 'ok');
      } else {
        conLog('  ⚠ No checkpoints returned — ensure ComfyUI is connected', 'warn');
      }
    } catch (e) {
      conLog(`  ✗ Discovery failed: ${e.message}. Test ComfyUI connection first.`, 'err');
    }
  }

  async function saveDefaultWorkflow() {
    const statusEl = document.getElementById('dwSaveStatus');
    const model = document.getElementById('dw_model').value;
    if (!model) {
      statusEl.textContent = 'Select a checkpoint model first';
      statusEl.style.color = 'var(--err)';
      return;
    }

    const params = {
      model,
      width: parseInt(document.getElementById('dw_width').value) || 512,
      height: parseInt(document.getElementById('dw_height').value) || 512,
      steps: parseInt(document.getElementById('dw_steps').value) || 20,
      cfg: parseFloat(document.getElementById('dw_cfg').value) || 7.0,
      sampler: document.getElementById('dw_sampler').value || 'euler_ancestral',
      scheduler: document.getElementById('dw_scheduler').value || 'beta',
      denoise: parseFloat(document.getElementById('dw_denoise').value),
    };

    if (isNaN(params.denoise)) params.denoise = 0.88;

    statusEl.textContent = 'Saving…';
    statusEl.style.color = 'var(--text-dim)';
    conLog(`[${new Date().toISOString()}] Saving default workflow settings…`);

    try {
      const res = await fetch('/api/config/default-workflow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params),
      });
      const data = await res.json();
      if (data.success) {
        statusEl.textContent = 'Saved ✓';
        statusEl.style.color = 'var(--ok)';
        conLog('  ✓ Default workflow settings saved', 'ok');
        updateDefaultWorkflowInfo();
      } else {
        const errMsg = data.errors ? data.errors.join(', ') : (data.error || 'Unknown error');
        statusEl.textContent = 'Error: ' + errMsg;
        statusEl.style.color = 'var(--err)';
        conLog(`  ✗ Save failed: ${errMsg}`, 'err');
      }
    } catch (e) {
      statusEl.textContent = 'Error: ' + e.message;
      statusEl.style.color = 'var(--err)';
      conLog(`  ✗ Save failed: ${e.message}`, 'err');
    }
  }

  async function deleteCustomWorkflow() {
    if (!confirm('Remove the custom workflow? The default workflow settings will be used instead.')) return;
    conLog(`[${new Date().toISOString()}] Removing custom workflow…`);
    try {
      const res = await fetch('/api/config/workflow', { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        conLog('  ✓ ' + data.message, 'ok');
        _hasCustomWorkflow = false;
        document.getElementById('workflowStatus').innerHTML = '<span style="color:var(--text-dim)">No workflow uploaded</span>';
        document.getElementById('customWorkflowActions').style.display = 'none';
        updateDefaultWorkflowInfo();
      } else {
        conLog('  ✗ ' + (data.error || 'Failed'), 'err');
      }
    } catch (e) {
      conLog(`  ✗ Delete failed: ${e.message}`, 'err');
    }
  }

  // Tracks whether a custom workflow is currently uploaded (set from config API, not DOM text)
  let _hasCustomWorkflow = false;

  function updateDefaultWorkflowInfo() {
    const infoEl = document.getElementById('defaultWorkflowInfo');
    const hasCustom = _hasCustomWorkflow;
    const hasModel = document.getElementById('dw_model').value;

    document.getElementById('customWorkflowActions').style.display = hasCustom ? '' : 'none';

    if (hasCustom) {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(255,183,77,0.08)';
      infoEl.style.border = '1px solid rgba(255,183,77,0.3)';
      infoEl.innerHTML = '⚠ A custom workflow is uploaded and takes precedence. Default workflow settings are saved but inactive.';
    } else if (hasModel) {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(129,199,132,0.08)';
      infoEl.style.border = '1px solid rgba(129,199,132,0.3)';
      infoEl.innerHTML = '✓ Default workflow is active with the settings below.';
    } else {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(144,164,174,0.08)';
      infoEl.style.border = '1px solid rgba(144,164,174,0.3)';
      infoEl.innerHTML = 'No workflow configured. Select a checkpoint model and save to enable the default workflow.';
    }
  }

  // ── Test image generation ───────────────────────────
  async function testGenerateImage() {
    const prompt = document.getElementById('testPrompt').value.trim();
    if (!prompt) {
      conLog(`[${new Date().toISOString()}] Enter a prompt to test image generation`, 'warn');
      return;
    }

    const btn = document.getElementById('btnTestGenerate');
    const statusEl = document.getElementById('testGenStatus');
    const resultsEl = document.getElementById('testGenResults');
    const imagesEl = document.getElementById('testGenImages');

    btn.disabled = true;
    btn.textContent = '⏳';
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<span style="color:var(--warn)">⏳ Generating… this may take a few minutes</span>';
    resultsEl.style.display = 'none';
    imagesEl.innerHTML = '';

    conLog(`[${new Date().toISOString()}] Test image generation started — "${prompt.substring(0, 80)}"…`);

    try {
      const res = await fetch('/api/test/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
      });

      const data = await res.json();

      if (data.success && data.images && data.images.length > 0) {
        statusEl.innerHTML = `<span style="color:var(--ok)">✓ Generated ${data.images.length} image(s)</span>`;
        resultsEl.style.display = 'block';

        for (const url of data.images) {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'border:1px solid var(--border);border-radius:4px;overflow:hidden;background:var(--surface)';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Generated image';
          img.style.cssText = 'max-width:256px;max-height:256px;display:block';
          img.onerror = function() { this.alt = 'Failed to load image'; this.style.padding = '20px'; };

          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.style.cssText = 'display:block;font-size:0.75em;padding:4px 8px;color:var(--text-dim);word-break:break-all';
          link.textContent = url;

          wrapper.appendChild(img);
          wrapper.appendChild(link);
          imagesEl.appendChild(wrapper);
        }

        conLog(`  ✓ Test generation complete — ${data.images.length} image(s)`, 'ok');
        for (const url of data.images) {
          conLog(`    • ${url}`);
        }
      } else {
        const errMsg = data.error || 'Generation failed — no images returned';
        statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(errMsg)}</span>`;
        resultsEl.style.display = 'none';
        conLog(`  ✗ Test generation failed: ${errMsg}`, 'err');
      }
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(e.message)}</span>`;
      resultsEl.style.display = 'none';
      conLog(`  ✗ Test generation error: ${e.message}`, 'err');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
      await pollStatus();
    }
  }

  // ── Helpers ────────────────────────────────────────
  function esc(s) {
    return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ── Init ───────────────────────────────────────────
  attachDirtyListeners();
  loadConfig();
  pollStatus();
  pollBotStatus();
  setInterval(pollStatus, 5000);
  setInterval(pollBotStatus, 3000);
</script>
</body>
</html>
