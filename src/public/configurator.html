<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot Configurator</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--surface);
    padding: 12px 24px;
    border-bottom: 2px solid var(--accent);
    display: flex;
    align-items: center;
    gap: 16px;
  }
  header h1 { font-size: 1.2em; font-weight: 600; }
  header .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--ok);
    display: inline-block;
  }
  header .dot.off { background: var(--err); }
  header .dot.warn { background: var(--warn); }
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .config-panel {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .console-panel {
    width: 360px;
    background: #0d0d1a;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .console-panel h3 {
    padding: 10px 14px;
    background: var(--surface);
    font-size: 0.85em;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
  }
  #console {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.78em;
    line-height: 1.6;
    color: var(--text-dim);
    white-space: pre-wrap;
    word-break: break-all;
  }
  #console .line { margin-bottom: 2px; }
  #console .line.err { color: var(--err); }
  #console .line.ok { color: var(--ok); }
  #console .line.warn { color: var(--warn); }

  section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  section h2 {
    font-size: 0.9em;
    padding: 10px 16px;
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  section h2::before {
    content: '▸';
    transition: transform 0.2s;
    display: inline-block;
  }
  section h2.open::before { transform: rotate(90deg); }
  section .body { padding: 16px; display: none; }
  section .body.open { display: block; }

  .field { margin-bottom: 14px; }
  .field label {
    display: block;
    font-size: 0.8em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .field label .note {
    font-style: italic;
    color: var(--accent);
    font-size: 0.9em;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 0.9em;
    font-family: inherit;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  .field input.dirty, .field textarea.dirty {
    border-color: var(--warn);
  }
  .field-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  .field-row .field { flex: 1; }
  .field-row .field.narrow { flex: 0 0 120px; }
  .field-row .field.tiny { flex: 0 0 90px; }

  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-family: inherit;
    transition: opacity 0.2s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-secondary { background: var(--accent2); color: #fff; }
  .btn-sm { padding: 5px 10px; font-size: 0.8em; }
  .btn-test { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--err); color: #fff; }

  .actions-bar {
    padding: 16px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .actions-bar .spacer { flex: 1; }
  .actions-bar .msg {
    font-size: 0.82em;
    color: var(--text-dim);
  }
  .actions-bar .msg.warn { color: var(--warn); }
  .actions-bar .msg.ok { color: var(--ok); }
  .actions-bar .msg.err { color: var(--err); }

  /* Keywords table */
  .kw-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .kw-table th {
    text-align: left;
    font-size: 0.75em;
    color: var(--text-dim);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .kw-table td { padding: 4px 8px; }
  .kw-table input, .kw-table select {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-size: 0.85em;
  }
  .kw-table .btn-sm { padding: 4px 8px; }

  /* Bot control bar */
  .bot-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  .bot-controls .status-label {
    font-size: 0.85em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .bot-controls .status-label .dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block;
  }
  .bot-controls .status-label .dot.running { background: var(--ok); }
  .bot-controls .status-label .dot.stopped { background: var(--err); }
  .bot-controls .status-label .dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  .bot-controls .status-label .dot.error { background: var(--err); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .bot-controls .spacer { flex: 1; }
  .btn-ok { background: var(--ok); color: #fff; }
</style>
</head>
<body>

<header>
  <span class="dot" id="statusDot"></span>
  <h1>Bot Configurator</h1>
</header>

<div class="main">
  <div class="config-panel">

    <!-- Discord Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Discord Connection</h2>
      <div class="body open">
        <div class="field">
          <label>Client ID</label>
          <input type="text" id="discord_client_id" data-env="DISCORD_CLIENT_ID" placeholder="Discord Application Client ID">
        </div>
        <div class="field">
          <label>Bot Token <span class="note">write-only — never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="discord_token" placeholder="Paste new token to update" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testDiscord()">Test</button>
            </div>
          </div>
        </div>
        <div class="bot-controls">
          <span class="status-label">
            <span class="dot stopped" id="botDot"></span>
            <span id="botStatusText">Stopped</span>
          </span>
          <span class="spacer"></span>
          <button class="btn-ok btn-sm" id="btnStart" onclick="startBot()">▶ Start</button>
          <button class="btn-danger btn-sm" id="btnStop" onclick="stopBot()" disabled>■ Stop</button>
        </div>
      </div>
    </section>

    <!-- API Endpoints Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">API Endpoints</h2>
      <div class="body open">
        <!-- ComfyUI -->
        <div class="field-row">
          <div class="field">
            <label>ComfyUI Endpoint</label>
            <input type="text" id="comfyui_endpoint" data-env="COMFYUI_ENDPOINT" placeholder="http://localhost:8188">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('comfyui')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>ComfyUI Workflow</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Upload a ComfyUI workflow JSON file. The workflow must contain at least one <code>%prompt%</code> placeholder (case-sensitive) which will be replaced with the Discord message prompt. All occurrences of <code>%prompt%</code> will be substituted.
          </p>
          <div class="field-row">
            <div class="field">
              <input type="file" id="workflow_file" accept=".json" style="font-size:0.82em" onchange="handleWorkflowUpload(this)">
            </div>
          </div>
          <div id="workflowStatus" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
        </div>

        <!-- Test Image Generation -->
        <div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <label style="display:block;font-size:0.8em;color:var(--text-dim);margin-bottom:6px">Test Image Generation <span class="note">submit a prompt directly to ComfyUI</span></label>
          <div class="field-row" style="margin-bottom:8px">
            <div class="field">
              <input type="text" id="testPrompt" value="a picture of a banana" placeholder="Enter a test prompt…">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" id="btnTestGenerate" onclick="testGenerateImage()">Generate</button>
            </div>
          </div>
          <div id="testGenStatus" style="font-size:0.8em;color:var(--text-dim);display:none"></div>
          <div id="testGenResults" style="margin-top:8px;display:none">
            <div id="testGenImages" style="display:flex;flex-wrap:wrap;gap:10px"></div>
          </div>
        </div>

        <hr style="border-color:var(--border);margin:16px 0">

        <!-- Ollama -->
        <div class="field-row">
          <div class="field">
            <label>Ollama Endpoint</label>
            <input type="text" id="ollama_endpoint" data-env="OLLAMA_ENDPOINT" placeholder="http://localhost:11434">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('ollama')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>Ollama Model</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Select a model from the Ollama instance. Click <strong>Test</strong> above to refresh the model list.
          </p>
          <select id="ollama_model" data-env="OLLAMA_MODEL" onchange="markDirty()">
            <option value="">— click Test to load models —</option>
          </select>
        </div>
        <div class="field">
          <label>
            System Prompt
            <span class="note">sets the bot's personality for all Ollama responses</span>
            <button class="btn-sm" style="margin-left:8px;font-size:0.85em;vertical-align:middle" onclick="resetSystemPrompt()">Reset to Default</button>
          </label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            This prompt is sent with every Ollama request to set context and personality. Leave empty to use raw model behavior with no system context.
          </p>
          <textarea id="ollama_system_prompt" data-env="OLLAMA_SYSTEM_PROMPT" rows="4" style="width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.9em;font-family:inherit;resize:vertical" placeholder="You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate—if someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful."></textarea>
        </div>
      </div>
    </section>

    <!-- Error Handling Section -->
    <section>
      <h2 onclick="toggleSection(this)">Error Handling</h2>
      <div class="body">
        <div class="field">
          <label>Error Message <span class="note">sent to Discord users when an error occurs</span></label>
          <input type="text" id="error_message" data-env="ERROR_MESSAGE" placeholder="I'm experiencing technical difficulties. Please try again later.">
        </div>
        <div class="field narrow">
          <label>Error Rate Limit (minutes) <span class="note">minimum time between error messages</span></label>
          <input type="number" id="error_rate_limit" data-env="ERROR_RATE_LIMIT_MINUTES" placeholder="60" min="1">
        </div>
      </div>
    </section>

    <!-- HTTP Server Section -->
    <section>
      <h2 onclick="toggleSection(this)">HTTP Server</h2>
      <div class="body">
        <div class="field-row">
          <div class="field narrow">
            <label>Port <span class="note">restart</span></label>
            <input type="number" id="http_port" data-env="HTTP_PORT" placeholder="3000">
          </div>
          <div class="field">
            <label>Output Base URL</label>
            <input type="text" id="output_base_url" data-env="OUTPUT_BASE_URL" placeholder="http://localhost:3000">
          </div>
        </div>
      </div>
    </section>

    <!-- Limits Section -->
    <section>
      <h2 onclick="toggleSection(this)">Limits</h2>
      <div class="body">
        <div class="field-row">
          <div class="field">
            <label>File Size Threshold (bytes)</label>
            <input type="number" id="file_size_threshold" data-env="FILE_SIZE_THRESHOLD" placeholder="10485760">
          </div>
          <div class="field narrow">
            <label>Default Timeout (sec)</label>
            <input type="number" id="default_timeout" data-env="DEFAULT_TIMEOUT" placeholder="300">
          </div>
        </div>
        <div class="field narrow">
          <label>Max Attachments per Message <span class="note">1–10, Discord limit is 10</span></label>
          <input type="number" id="max_attachments" data-env="MAX_ATTACHMENTS" placeholder="10" min="1" max="10">
        </div>
      </div>
    </section>
    <!-- Reply Chain Section -->
    <section>
      <h2 onclick="toggleSection(this)">Reply Chain Context</h2>
      <div class="body">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          When users reply to previous messages, the bot traverses the reply chain to build conversation history for Ollama. This enables multi-turn conversations.
        </p>
        <div class="field-row">
          <div class="field narrow">
            <label>Enabled</label>
            <select id="reply_chain_enabled" data-env="REPLY_CHAIN_ENABLED" onchange="markDirty()">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field narrow">
            <label>Max Depth <span class="note">1–50 messages</span></label>
            <input type="number" id="reply_chain_max_depth" data-env="REPLY_CHAIN_MAX_DEPTH" placeholder="10" min="1" max="50">
          </div>
          <div class="field narrow">
            <label>Max Tokens <span class="note">1,000–128,000 chars</span></label>
            <input type="number" id="reply_chain_max_tokens" data-env="REPLY_CHAIN_MAX_TOKENS" placeholder="16000" min="1000" max="128000">
          </div>
        </div>
      </div>
    </section>
    <!-- Keywords Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Keywords → API Routing</h2>
      <div class="body open">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          Map @mention keywords to APIs. Slash commands <code>/generate</code> and <code>/ask</code> are hardcoded in bot code.
        </p>
        <table class="kw-table">
          <thead>
            <tr>
              <th>Keyword</th>
              <th>API</th>
              <th>Timeout (s)</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="kwBody"></tbody>
        </table>
        <div style="margin-top:10px">
          <button class="btn-secondary btn-sm" onclick="addKeywordRow()">+ Add Keyword</button>
        </div>
      </div>
    </section>

  </div>

  <!-- Console Panel -->
  <div class="console-panel">
    <h3>Status Console</h3>
    <div id="console"></div>
  </div>
</div>

<!-- Bottom action bar -->
<div class="actions-bar">
  <button class="btn-secondary btn-sm" onclick="loadConfig()">↻ Reload</button>
  <span class="spacer"></span>
  <span class="msg" id="saveMsg"></span>
  <button class="btn-primary" id="saveBtn" disabled onclick="saveConfig()">Save Changes</button>
</div>

<script>
  // ── State ──────────────────────────────────────────
  let originalConfig = null;
  let dirty = false;

  // ── Section toggle ─────────────────────────────────
  function toggleSection(h2) {
    h2.classList.toggle('open');
    h2.nextElementSibling.classList.toggle('open');
  }

  // ── Console ────────────────────────────────────────
  const consoleEl = document.getElementById('console');

  function conLog(text, cls = '') {
    const d = document.createElement('div');
    d.className = 'line' + (cls ? ' ' + cls : '');
    d.textContent = text;
    consoleEl.appendChild(d);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  async function pollStatus() {
    try {
      const res = await fetch('/api/config/status');
      const data = await res.json();
      consoleEl.innerHTML = '';
      for (const line of data.lines) {
        // Classify by structured log level tags, with keyword highlights for info
        const cls = line.includes('[error]') ? 'err'
          : line.includes('[warn]') ? 'warn'
          : (line.includes(' OK') || line.includes('started') || line.includes('logged in') || line.includes('saved') || line.includes('Authenticated') || line.includes('Loaded ')) ? 'ok'
          : '';
        conLog(line, cls);
      }
    } catch (e) {
      // server not reachable
    }
  }

  // ── Bot status polling ─────────────────────────────
  async function pollBotStatus() {
    try {
      const res = await fetch('/api/discord/status');
      const data = await res.json();
      updateBotUI(data);
    } catch (e) {
      updateBotUI({ status: 'stopped', username: null, error: null, tokenConfigured: false });
    }
  }

  function updateBotUI(data) {
    const dot = document.getElementById('botDot');
    const text = document.getElementById('botStatusText');
    const headerDot = document.getElementById('statusDot');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');

    dot.className = 'dot ' + data.status;

    switch (data.status) {
      case 'running':
        text.textContent = `Connected as ${data.username || '?'}`;
        headerDot.className = 'dot';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'connecting':
        text.textContent = 'Connecting…';
        headerDot.className = 'dot warn';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'error':
        text.textContent = `Error: ${data.error || 'unknown'}`;
        headerDot.className = 'dot off';
        btnStart.disabled = false;
        btnStop.disabled = true;
        break;
      default:
        text.textContent = data.tokenConfigured ? 'Stopped' : 'Stopped — no token configured';
        headerDot.className = 'dot off';
        btnStart.disabled = !data.tokenConfigured;
        btnStop.disabled = true;
    }
  }

  // ── Dirty tracking ─────────────────────────────────
  function markDirty() {
    dirty = true;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('saveMsg').textContent = 'Unsaved changes';
    document.getElementById('saveMsg').className = 'msg warn';
  }

  function markClean() {
    dirty = false;
    document.getElementById('saveBtn').disabled = true;
  }

  // Attach to all env inputs + token field
  function attachDirtyListeners() {
    document.querySelectorAll('[data-env]').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.add('dirty');
        markDirty();
      });
    });
    document.getElementById('discord_token').addEventListener('input', () => {
      if (document.getElementById('discord_token').value.trim()) {
        markDirty();
      }
    });
  }

  // ── System prompt reset ────────────────────────────
  const DEFAULT_SYSTEM_PROMPT = "You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate\u2014if someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful.";

  function resetSystemPrompt() {
    const el = document.getElementById('ollama_system_prompt');
    el.value = DEFAULT_SYSTEM_PROMPT;
    el.classList.add('dirty');
    markDirty();
  }

  // ── Load config ────────────────────────────────────
  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const cfg = await res.json();
      originalConfig = cfg;

      // Populate env fields
      document.getElementById('discord_client_id').value = cfg.discord.clientId;
      document.getElementById('comfyui_endpoint').value = cfg.apis.comfyui;
      document.getElementById('ollama_endpoint').value = cfg.apis.ollama;
      document.getElementById('http_port').value = cfg.http.port;
      document.getElementById('output_base_url').value = cfg.http.outputBaseUrl;
      document.getElementById('file_size_threshold').value = cfg.limits.fileSizeThreshold;
      document.getElementById('default_timeout').value = cfg.limits.defaultTimeout;
      document.getElementById('max_attachments').value = cfg.limits.maxAttachments;

      // Populate Ollama model (saved selection)
      const modelSelect = document.getElementById('ollama_model');
      if (cfg.apis.ollamaModel) {
        // Ensure the saved model is in the dropdown
        const exists = Array.from(modelSelect.options).some(o => o.value === cfg.apis.ollamaModel);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = cfg.apis.ollamaModel;
          opt.textContent = cfg.apis.ollamaModel + ' (saved)';
          modelSelect.appendChild(opt);
        }
        modelSelect.value = cfg.apis.ollamaModel;
      }

      // Populate ComfyUI workflow status
      const workflowStatus = document.getElementById('workflowStatus');
      if (cfg.apis.comfyuiWorkflowConfigured) {
        workflowStatus.innerHTML = '<span style="color:var(--ok)">✓ Workflow configured</span>';
      } else {
        workflowStatus.innerHTML = '<span style="color:var(--text-dim)">No workflow uploaded</span>';
      }

      // Populate Ollama system prompt
      const systemPromptEl = document.getElementById('ollama_system_prompt');
      if (cfg.apis.ollamaSystemPrompt) {
        systemPromptEl.value = cfg.apis.ollamaSystemPrompt;
      }

      // Populate error handling fields
      document.getElementById('error_message').value = cfg.errorHandling?.errorMessage || '';
      document.getElementById('error_rate_limit').value = cfg.errorHandling?.errorRateLimitMinutes || 60;

      // Populate reply chain fields
      const rcEnabled = document.getElementById('reply_chain_enabled');
      rcEnabled.value = cfg.replyChain?.enabled === false ? 'false' : 'true';
      document.getElementById('reply_chain_max_depth').value = cfg.replyChain?.maxDepth || 10;
      document.getElementById('reply_chain_max_tokens').value = cfg.replyChain?.maxTokens || 16000;

      // Token field is always empty (write-only) — just show placeholder
      document.getElementById('discord_token').value = '';
      document.getElementById('discord_token').placeholder =
        cfg.discord.tokenConfigured ? 'Token configured ✓ — paste new value to change' : 'Paste Discord bot token here';

      // Populate keywords
      renderKeywords(cfg.keywords);

      // Clear dirty state
      document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
      markClean();
      document.getElementById('saveMsg').textContent = 'Config loaded';
      document.getElementById('saveMsg').className = 'msg ok';
      document.getElementById('statusDot').className = 'dot';

      conLog(`[${new Date().toISOString()}] Config loaded from server`, 'ok');
    } catch (e) {
      document.getElementById('statusDot').className = 'dot off';
      conLog(`[${new Date().toISOString()}] Failed to load config: ${e.message}`, 'err');
    }
  }

  // ── Keywords table ─────────────────────────────────
  function renderKeywords(keywords) {
    const tbody = document.getElementById('kwBody');
    tbody.innerHTML = '';
    for (const kw of keywords) {
      addKeywordRow(kw);
    }
  }

  function addKeywordRow(kw = null) {
    const tbody = document.getElementById('kwBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="kw-keyword" value="${esc(kw?.keyword || '')}" placeholder="keyword"></td>
      <td><select class="kw-api">
        <option value="comfyui" ${kw?.api === 'comfyui' ? 'selected' : ''}>comfyui</option>
        <option value="ollama" ${kw?.api === 'ollama' ? 'selected' : ''}>ollama</option>
      </select></td>
      <td><input type="number" class="kw-timeout" value="${kw?.timeout || 300}" style="width:70px"></td>
      <td><input type="text" class="kw-desc" value="${esc(kw?.description || '')}" placeholder="description"></td>
      <td><button class="btn-danger btn-sm" onclick="this.closest('tr').remove();markDirty()">✕</button></td>
    `;
    // Attach dirty listeners to new row inputs
    tr.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', markDirty);
      el.addEventListener('change', markDirty);
    });
    tbody.appendChild(tr);
  }

  function collectKeywords() {
    const rows = document.querySelectorAll('#kwBody tr');
    const keywords = [];
    for (const row of rows) {
      const keyword = row.querySelector('.kw-keyword').value.trim();
      if (!keyword) continue;
      keywords.push({
        keyword,
        api: row.querySelector('.kw-api').value,
        timeout: parseInt(row.querySelector('.kw-timeout').value, 10) || 300,
        description: row.querySelector('.kw-desc').value.trim() || keyword,
      });
    }
    return keywords;
  }

  // ── Save ───────────────────────────────────────────
  async function saveConfig() {
    const saveBtn = document.getElementById('saveBtn');
    const saveMsg = document.getElementById('saveMsg');
    saveBtn.disabled = true;
    saveMsg.textContent = 'Saving…';
    saveMsg.className = 'msg';

    try {
      // Collect env changes — include empty values so users can clear fields
      const env = {};
      document.querySelectorAll('[data-env]').forEach(input => {
        const key = input.dataset.env;
        // Skip DISCORD_TOKEN here — handled specially below
        if (key === 'DISCORD_TOKEN') return;
        env[key] = input.value.trim();
      });

      // Include token only if user typed a new value (write-only field)
      const tokenInput = document.getElementById('discord_token');
      const tokenVal = tokenInput.value.trim();
      if (tokenVal) {
        env['DISCORD_TOKEN'] = tokenVal;
      }

      // Collect keywords
      const keywords = collectKeywords();

      const res = await fetch('/api/config/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ env, keywords }),
      });

      const result = await res.json();

      if (result.success) {
        document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
        markClean();
        // Clear the token input after successful save
        tokenInput.value = '';
        tokenInput.placeholder = 'Token configured ✓ — paste new value to change';
        saveMsg.textContent = result.messages.join(' | ');
        saveMsg.className = 'msg ok';
        conLog(`[${new Date().toISOString()}] Save successful`, 'ok');
        for (const m of result.messages) {
          conLog(`  ${m}`, m.includes('⚠') ? 'warn' : 'ok');
        }
        // Refresh status
        await pollStatus();
        await pollBotStatus();
      } else {
        saveMsg.textContent = result.error;
        saveMsg.className = 'msg err';
        saveBtn.disabled = false;
        conLog(`[${new Date().toISOString()}] Save failed: ${result.error}`, 'err');
      }
    } catch (e) {
      saveMsg.textContent = `Error: ${e.message}`;
      saveMsg.className = 'msg err';
      saveBtn.disabled = false;
      conLog(`[${new Date().toISOString()}] Save error: ${e.message}`, 'err');
    }
  }

  // ── Test connection ────────────────────────────────
  async function testConnection(api) {
    conLog(`[${new Date().toISOString()}] Testing ${api} connection…`);
    try {
      const res = await fetch(`/api/config/test-connection/${api}`);
      const data = await res.json();
      if (data.healthy) {
        conLog(`  ✓ ${api} at ${data.endpoint} is reachable`, 'ok');

        // For Ollama, populate model dropdown from returned models
        if (api === 'ollama' && data.models && data.models.length > 0) {
          const modelSelect = document.getElementById('ollama_model');
          const currentValue = modelSelect.value;
          modelSelect.innerHTML = '';

          // Add default empty option
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = '— select a model —';
          modelSelect.appendChild(defaultOpt);

          // Add each model
          for (const model of data.models) {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = `${model.name} (${model.parameterSize}, ${model.family}, ${model.quantization})`;
            modelSelect.appendChild(opt);
          }

          // Restore previous selection if it still exists
          if (currentValue) {
            const exists = Array.from(modelSelect.options).some(o => o.value === currentValue);
            if (exists) {
              modelSelect.value = currentValue;
            }
          }

          conLog(`  ✓ Found ${data.models.length} model(s)`, 'ok');
          for (const m of data.models) {
            conLog(`    • ${m.name} (${m.parameterSize}, ${m.family})`);
          }
        }
      } else {
        conLog(`  ✗ ${api} at ${data.endpoint} is not reachable`, 'err');
        if (data.error) conLog(`    ${data.error}`, 'err');
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ✗ Test failed: ${e.message}`, 'err');
    }
  }

  // ── Discord controls ──────────────────────────────
  async function testDiscord() {
    const token = document.getElementById('discord_token').value.trim();
    if (!token) {
      conLog(`[${new Date().toISOString()}] Enter a token to test`, 'warn');
      return;
    }
    conLog(`[${new Date().toISOString()}] Testing Discord token…`);
    try {
      const res = await fetch('/api/discord/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });
      const data = await res.json();
      if (data.success) {
        conLog(`  ✓ ${data.message}`, 'ok');
      } else {
        conLog(`  ✗ ${data.message}`, 'err');
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ✗ Test failed: ${e.message}`, 'err');
    }
  }

  async function startBot() {
    conLog(`[${new Date().toISOString()}] Starting Discord bot…`);
    document.getElementById('btnStart').disabled = true;
    try {
      const res = await fetch('/api/discord/start', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '✓' : '✗'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      // Poll bot status a few times to catch the ready event
      for (let i = 0; i < 5; i++) {
        await new Promise(r => setTimeout(r, 1000));
        await pollBotStatus();
      }
    } catch (e) {
      conLog(`  ✗ Start failed: ${e.message}`, 'err');
      document.getElementById('btnStart').disabled = false;
    }
  }

  async function stopBot() {
    conLog(`[${new Date().toISOString()}] Stopping Discord bot…`);
    document.getElementById('btnStop').disabled = true;
    try {
      const res = await fetch('/api/discord/stop', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '✓' : '✗'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      await pollBotStatus();
    } catch (e) {
      conLog(`  ✗ Stop failed: ${e.message}`, 'err');
      document.getElementById('btnStop').disabled = false;
    }
  }

  // ── Workflow upload ─────────────────────────────────
  async function handleWorkflowUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const statusEl = document.getElementById('workflowStatus');
    statusEl.innerHTML = '<span style="color:var(--warn)">Uploading…</span>';
    conLog(`[${new Date().toISOString()}] Uploading workflow: ${file.name}…`);

    try {
      const text = await file.text();

      const res = await fetch('/api/config/upload-workflow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workflow: text, filename: file.name }),
      });

      const data = await res.json();

      if (data.success) {
        statusEl.innerHTML = `<span style="color:var(--ok)">✓ ${esc(file.name)} — validation passed</span>`;
        conLog(`  ✓ Workflow "${file.name}" uploaded and validated`, 'ok');
      } else {
        statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(file.name)} — ${esc(data.error)}</span>`;
        conLog(`  ✗ Workflow validation failed: ${data.error}`, 'err');
      }

      await pollStatus();
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">✗ Upload failed: ${esc(e.message)}</span>`;
      conLog(`  ✗ Workflow upload failed: ${e.message}`, 'err');
    }

    // Reset the file input so the same file can be re-uploaded
    input.value = '';
  }

  // ── Test image generation ───────────────────────────
  async function testGenerateImage() {
    const prompt = document.getElementById('testPrompt').value.trim();
    if (!prompt) {
      conLog(`[${new Date().toISOString()}] Enter a prompt to test image generation`, 'warn');
      return;
    }

    const btn = document.getElementById('btnTestGenerate');
    const statusEl = document.getElementById('testGenStatus');
    const resultsEl = document.getElementById('testGenResults');
    const imagesEl = document.getElementById('testGenImages');

    btn.disabled = true;
    btn.textContent = '⏳';
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<span style="color:var(--warn)">⏳ Generating… this may take a few minutes</span>';
    resultsEl.style.display = 'none';
    imagesEl.innerHTML = '';

    conLog(`[${new Date().toISOString()}] Test image generation started — "${prompt.substring(0, 80)}"…`);

    try {
      const res = await fetch('/api/test/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
      });

      const data = await res.json();

      if (data.success && data.images && data.images.length > 0) {
        statusEl.innerHTML = `<span style="color:var(--ok)">✓ Generated ${data.images.length} image(s)</span>`;
        resultsEl.style.display = 'block';

        for (const url of data.images) {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'border:1px solid var(--border);border-radius:4px;overflow:hidden;background:var(--surface)';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Generated image';
          img.style.cssText = 'max-width:256px;max-height:256px;display:block';
          img.onerror = function() { this.alt = 'Failed to load image'; this.style.padding = '20px'; };

          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.style.cssText = 'display:block;font-size:0.75em;padding:4px 8px;color:var(--text-dim);word-break:break-all';
          link.textContent = url;

          wrapper.appendChild(img);
          wrapper.appendChild(link);
          imagesEl.appendChild(wrapper);
        }

        conLog(`  ✓ Test generation complete — ${data.images.length} image(s)`, 'ok');
        for (const url of data.images) {
          conLog(`    • ${url}`);
        }
      } else {
        statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(data.error || 'Unknown error')}</span>`;
        conLog(`  ✗ Test generation failed: ${data.error || 'Unknown error'}`, 'err');
      }

      await pollStatus();
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">✗ ${esc(e.message)}</span>`;
      conLog(`  ✗ Test generation error: ${e.message}`, 'err');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
    }
  }

  // ── Helpers ────────────────────────────────────────
  function esc(s) {
    return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ── Init ───────────────────────────────────────────
  attachDirtyListeners();
  loadConfig();
  pollStatus();
  pollBotStatus();
  setInterval(pollStatus, 5000);
  setInterval(pollBotStatus, 3000);
</script>
</body>
</html>
