<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bot Configurator</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
  }
  
  /* Theme - Grayscale */
  .theme-grayscale {
    --bg: #f0f0f0;
    --surface: #e0e0e0;
    --surface2: #d0d0d0;
    --accent: #666666;
    --accent2: #555555;
    --text: #333333;
    --text-dim: #666666;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #cccccc;
  }
  
  /* Theme - Green */
  .theme-green {
    --bg: #0a251c;
    --surface: #0d3b29;
    --surface2: #11573c;
    --accent: #4caf50;
    --accent2: #388e3c;
    --text: #e8f5e9;
    --text-dim: #a5d6a7;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #1b5e20;
  }
  
  /* Theme - Orange */
  .theme-orange {
    --bg: #2e1a10;
    --surface: #442715;
    --surface2: #60381f;
    --accent: #ff9800;
    --accent2: #f57c00;
    --text: #fff3e0;
    --text-dim: #ffcc80;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #e65100;
  }
  
  /* Theme - Purple */
  .theme-purple {
    --bg: #1a0d3d;
    --surface: #2d1a5c;
    --surface2: #4a2a8c;
    --accent: #9c27b0;
    --accent2: #7b1fa2;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #6a3d9e;
  }
  
  /* Theme - Black with Cyan Accents */
  .theme-black-cyan {
    --bg: #000000;
    --surface: #111111;
    --surface2: #222222;
    --accent: #00ffff;
    --accent2: #00b3b3;
    --text: #ffffff;
    --text-dim: #cccccc;
    --ok: #00ff00;
    --warn: #ffff00;
    --err: #ff0000;
    --border: #333333;
  }
  
  /* Theme Selector UI */
  .theme-selector {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-left: auto; /* Pushes to the right */
    margin-right: 16px;
  }
  
  .theme-option {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #000000;
    transition: transform 0.2s ease;
    background-color: var(--surface2);
  }
  
  .theme-option:hover {
    transform: scale(1.2);
  }
  
  .theme-option.active {
    transform: scale(1.2);
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #000000;
  }
  
  /* Dark theme (applied via JS) */
  .theme-dark {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #533483;
    --text: #eee;
    --text-dim: #999;
    --ok: #4caf50;
    --warn: #ff9800;
    --err: #f44336;
    --border: #2a2a4a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--surface);
    padding: 12px 24px;
    border-bottom: 2px solid var(--accent);
    display: flex;
    align-items: center;
    gap: 16px;
  }
  header h1 { font-size: 1.2em; font-weight: 600; }
  header .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--ok);
    display: inline-block;
  }
  header .dot.off { background: var(--err); }
  header .dot.warn { background: var(--warn); }
  .main {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }
  .config-panel {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .console-panel {
    height: 150px;
    min-height: 80px;
    background: #0d0d1a;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }
  .console-panel-header {
    padding: 6px 14px;
    background: var(--surface);
    font-size: 0.85em;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
  }
  .console-panel-header:hover { background: var(--surface2); }
  .console-panel-header .hint {
    font-size: 0.8em;
    color: var(--text-dim);
    opacity: 0.6;
    margin-left: auto;
  }
  #console {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.78em;
    line-height: 1.6;
    color: var(--text-dim);
    white-space: pre-wrap;
    word-break: break-all;
  }
  #console .line { margin-bottom: 2px; }
  #console .line.err { color: var(--err); }
  #console .line.ok { color: var(--ok); }
  #console .line.warn { color: var(--warn); }

  /* ‚îÄ‚îÄ Log Modal (expanded viewer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .log-modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 900;
  }
  .log-modal-backdrop.open { display: block; }
  .log-modal {
    display: none;
    position: fixed;
    top: 5vh; left: 5vw; right: 5vw; bottom: 5vh;
    background: #0d0d1a;
    border: 1px solid var(--border);
    border-radius: 8px;
    z-index: 1000;
    flex-direction: column;
    overflow: hidden;
  }
  .log-modal.open { display: flex; }
  .log-modal-header {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    gap: 12px;
  }
  .log-modal-header h3 { font-size: 0.95em; flex: 1; }
  .log-modal-close {
    background: none; border: none;
    color: var(--text-dim);
    font-size: 1.3em;
    cursor: pointer;
    padding: 2px 8px;
    border-radius: 4px;
  }
  .log-modal-close:hover { background: var(--surface2); color: var(--text); }
  .log-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 14px 18px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.8em;
    line-height: 1.6;
    color: var(--text-dim);
    white-space: pre-wrap;
    word-break: break-all;
  }
  .log-modal-body .line { margin-bottom: 2px; }
  .log-modal-body .line.err { color: var(--err); }
  .log-modal-body .line.ok { color: var(--ok); }
  .log-modal-body .line.warn { color: var(--warn); }

  /* ‚îÄ‚îÄ Activity key result display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .activity-key-result {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.82em;
    padding: 4px 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-left: 8px;
  }
  .activity-key-result code {
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.95em;
    color: var(--ok);
    letter-spacing: 0.3px;
  }
  .activity-key-result .ttl { color: var(--text-dim); font-size: 0.9em; }

  section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  section h2 {
    font-size: 0.9em;
    padding: 10px 16px;
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  section h2::before {
    content: '‚ñ∏';
    transition: transform 0.2s;
    display: inline-block;
  }
  section h2.open::before { transform: rotate(90deg); }
  section .body { padding: 16px; display: none; }
  section .body.open { display: block; }

  .field { margin-bottom: 14px; }
  .field label {
    display: block;
    font-size: 0.8em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .field label .note {
    font-style: italic;
    color: var(--accent);
    font-size: 0.9em;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 0.9em;
    font-family: inherit;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  .field input.dirty, .field textarea.dirty {
    border-color: var(--warn);
  }
  .field-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  .field-row .field { flex: 1; }
  .field-row .field.narrow { flex: 0 0 120px; }
  .field-row .field.tiny { flex: 0 0 90px; }

  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-family: inherit;
    transition: opacity 0.2s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-secondary { background: var(--accent2); color: #fff; }
  .btn-sm { padding: 5px 10px; font-size: 0.8em; }
  .btn-test { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--err); color: #fff; }

  .actions-bar {
    padding: 16px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .actions-bar .spacer { flex: 1; }
  .actions-bar .msg {
    font-size: 0.82em;
    color: var(--text-dim);
  }
  .actions-bar .msg.warn { color: var(--warn); }
  .actions-bar .msg.ok { color: var(--ok); }
  .actions-bar .msg.err { color: var(--err); }

  /* Keywords table */
  .kw-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .kw-table th {
    text-align: left;
    font-size: 0.75em;
    color: var(--text-dim);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .kw-table td { padding: 4px 8px; }
  .kw-table input, .kw-table select {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-size: 0.85em;
  }
  .kw-table .btn-sm { padding: 4px 8px; }
  .kw-table tr.kw-builtin input:not(.kw-enabled),
  .kw-table tr.kw-builtin select:not(.kw-enabled) {
    opacity: 0.6;
    pointer-events: none;
  }
  .kw-table tr.kw-builtin .kw-builtin-badge {
    font-size: 0.7em;
    color: var(--accent);
    margin-left: 4px;
    vertical-align: middle;
  }
  /* Keyword detail rows (expandable) */
  .kw-details-row { display: none; }
  .kw-details-row.open { display: table-row; }
  .kw-details-row td { padding: 6px 8px 10px; }
  .kw-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px 12px;
    font-size: 0.82em;
  }
  .kw-details-grid label {
    display: block;
    font-size: 0.75em;
    color: var(--text-dim);
    margin-bottom: 2px;
  }
  .kw-details-grid input,
  .kw-details-grid select,
  .kw-details-grid textarea {
    width: 100%;
    padding: 5px 7px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-size: 0.92em;
    font-family: inherit;
  }
  .kw-details-grid textarea { resize: vertical; min-height: 28px; }
  .kw-details-grid .field-full { grid-column: 1 / -1; }
  .kw-details-grid .field-half { grid-column: span 1; }
  .kw-details-grid .section-label {
    grid-column: 1 / -1;
    font-size: 0.72em;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
    border-top: 1px solid var(--border);
    padding-top: 4px;
  }
  .kw-expand-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.85em;
    padding: 2px 6px;
    border-radius: 3px;
  }
  .kw-expand-btn:hover { color: var(--text); background: var(--surface2); }
  /* Visual separator between keyword entry groups (main row + detail row) */
  .kw-table tr.kw-separator-top > td {
    border-top: 1px solid var(--border);
  }

  /* Bot control bar */
  .bot-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  .bot-controls .status-label {
    font-size: 0.85em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .bot-controls .status-label .dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block;
  }
  .bot-controls .status-label .dot.running { background: var(--ok); }
  .bot-controls .status-label .dot.stopped { background: var(--err); }
  .bot-controls .status-label .dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  .bot-controls .status-label .dot.error { background: var(--err); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .bot-controls .spacer { flex: 1; }
  .btn-ok { background: var(--ok); color: #fff; }
  .kw-ctx-label { font-size: 0.72em; color: var(--text-dim); vertical-align: middle; }
  .kw-ctx-depth-stacked { display: flex; flex-direction: column; gap: 4px; }
  .kw-ctx-row { display: flex; align-items: center; gap: 4px; }
  .kw-ctx-row .kw-ctx-label { min-width: 26px; text-align: right; }
</style>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
</head>
<body>

<header>
  <span class="dot" id="statusDot"></span>
  <h1>Bot Configurator</h1>
  <div class="theme-selector">
    <div class="theme-option theme-dark" data-theme="dark" title="Dark" role="button" aria-label="Dark theme" tabindex="0"></div>
    <div class="theme-option theme-grayscale" data-theme="grayscale" title="Grayscale" role="button" aria-label="Grayscale theme" tabindex="0"></div>
    <div class="theme-option theme-green" data-theme="green" title="Green" role="button" aria-label="Green theme" tabindex="0"></div>
    <div class="theme-option theme-orange" data-theme="orange" title="Orange" role="button" aria-label="Orange theme" tabindex="0"></div>
    <div class="theme-option theme-purple" data-theme="purple" title="Purple" role="button" aria-label="Purple theme" tabindex="0"></div>
    <div class="theme-option theme-black-cyan" data-theme="black-cyan" title="Black/Cyan" role="button" aria-label="Black/Cyan theme" tabindex="0"></div>
  </div>
</header>

<div class="main">
  <div class="config-panel">

    <!-- Discord Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Discord Connection</h2>
      <div class="body open">
        <div class="field">
          <label>Client ID</label>
          <input type="text" id="discord_client_id" data-env="DISCORD_CLIENT_ID" placeholder="Discord Application Client ID">
        </div>
        <div class="field">
          <label>Bot Token <span class="note">write-only ‚Äî never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="discord_token" placeholder="Paste new token to update" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testDiscord()">Test</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Bot Display Name <span class="note">override for prompt identity ‚Äî blank uses Discord display name</span></label>
          <input type="text" id="bot_display_name" data-env="BOT_DISPLAY_NAME" placeholder="Blank uses Discord Display Name">
        </div>
        <div class="bot-controls">
          <span class="status-label">
            <span class="dot stopped" id="botDot"></span>
            <span id="botStatusText">Stopped</span>
          </span>
          <span class="spacer"></span>
          <button class="btn-ok btn-sm" id="btnStart" onclick="startBot()">‚ñ∂ Start</button>
          <button class="btn-danger btn-sm" id="btnStop" onclick="stopBot()" disabled>‚ñ† Stop</button>
        </div>
      </div>
    </section>

    <!-- ComfyUI Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">ComfyUI</h2>
      <div class="body open">
        <div class="field-row">
          <div class="field">
            <label>ComfyUI Endpoint</label>
            <input type="text" id="comfyui_endpoint" data-env="COMFYUI_ENDPOINT" placeholder="http://localhost:8190">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('comfyui')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>ComfyUI Workflow</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Upload a ComfyUI workflow JSON file exported using <strong>"Save (API Format)"</strong> in ComfyUI.
            The workflow must contain at least one <code>%prompt%</code> placeholder (case-sensitive) which will be replaced with the Discord message prompt.
            All occurrences of <code>%prompt%</code> will be substituted.
            <br><em>Note: UI-format workflows (standard "Save") will be auto-converted, but API format is recommended for reliability.</em>
          </p>
          <div class="field-row">
            <div class="field">
              <input type="file" id="workflow_file" accept=".json" style="font-size:0.82em" onchange="handleWorkflowUpload(this)">
            </div>
          </div>
          <div id="workflowStatus" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
          <div id="customWorkflowActions" style="margin-top:6px;display:none">
            <button class="btn-sm" style="font-size:0.78em;color:#e57373;border-color:#e57373" onclick="deleteCustomWorkflow()">Remove Custom Workflow</button>
            <span style="font-size:0.75em;color:var(--text-dim);margin-left:8px">Removes uploaded workflow so the default workflow is used instead</span>
          </div>
          <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
            <button class="btn-sm" style="font-size:0.78em" onclick="exportWorkflow()">Export Current Workflow</button>
            <span id="exportStatus" style="font-size:0.78em;color:var(--text-dim)"></span>
          </div>
        </div>

        <!-- Default Workflow Settings -->
        <div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <label style="display:block;font-size:0.9em;font-weight:600;margin:0">Workflow Settings</label>
            <button class="btn-sm" style="font-size:0.78em" onclick="discoverComfyUIOptions()">Discover Options</button>
          </div>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
            Configure a basic text-to-image workflow that will be used when no custom workflow is uploaded.
            Click <strong>Discover Options</strong> after testing the ComfyUI connection to populate dropdowns with available models, samplers, and schedulers.
            <br><em>Sampler Override:</em> Steps, CFG, Sampler, Scheduler, Denoise, and Seed are also applied as overrides to any uploaded workflow that contains <code>KSampler</code> nodes. Checkpoint Model, Width, and Height only apply to the default workflow. Other sampler node types (e.g. <code>KSamplerAdvanced</code>) are not affected.
          </p>
          <div id="defaultWorkflowInfo" style="font-size:0.78em;padding:6px 10px;border-radius:4px;margin-bottom:10px;display:none"></div>

          <div class="field">
            <label>Checkpoint Model</label>
            <select id="dw_model" style="width:100%">
              <option value="">‚Äî click Discover Options to load models ‚Äî</option>
            </select>
          </div>

          <div class="field-row">
            <div class="field narrow">
              <label>Width</label>
              <input type="number" id="dw_width" value="512" min="64" max="4096" step="8">
            </div>
            <div class="field narrow">
              <label>Height</label>
              <input type="number" id="dw_height" value="512" min="64" max="4096" step="8">
            </div>
            <div class="field narrow">
              <label>Steps</label>
              <input type="number" id="dw_steps" value="20" min="1" max="150" step="1">
            </div>
            <div class="field narrow">
              <label>CFG</label>
              <input type="number" id="dw_cfg" value="7.0" min="0.1" max="30" step="0.5">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Sampler</label>
              <select id="dw_sampler" style="width:100%">
                <option value="euler">euler</option>
                <option value="euler_ancestral" selected>euler_ancestral</option>
                <option value="heun">heun</option>
                <option value="dpmpp_2m">dpmpp_2m</option>
                <option value="dpmpp_2m_sde">dpmpp_2m_sde</option>
                <option value="lms">lms</option>
              </select>
            </div>
            <div class="field">
              <label>Scheduler</label>
              <select id="dw_scheduler" style="width:100%">
                <option value="normal">normal</option>
                <option value="karras">karras</option>
                <option value="exponential">exponential</option>
                <option value="simple">simple</option>
                <option value="beta" selected>beta</option>
              </select>
            </div>
            <div class="field narrow">
              <label>Denoise</label>
              <input type="number" id="dw_denoise" value="0.88" min="0" max="1" step="0.01">
            </div>
            <div class="field narrow">
              <label>Seed</label>
              <input type="number" id="dw_seed" value="-1" min="-1" max="2147483647" step="1">
              <span style="font-size:0.7em;color:var(--text-dim)">-1 = random</span>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
            <button class="btn-sm" onclick="saveDefaultWorkflow()">Save Workflow Settings</button>
            <span id="dwSaveStatus" style="font-size:0.8em;color:var(--text-dim)"></span>
          </div>
        </div>

        <!-- Test Image Generation -->
        <div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <label style="display:block;font-size:0.8em;color:var(--text-dim);margin-bottom:6px">Test Image Generation <span class="note">submit a prompt directly to ComfyUI</span></label>
          <div class="field-row" style="margin-bottom:8px">
            <div class="field">
              <input type="text" id="testPrompt" value="a picture of a banana" placeholder="Enter a test prompt‚Ä¶">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" id="btnTestGenerate" onclick="testGenerateImage()">Generate</button>
            </div>
          </div>
          <div id="testGenStatus" style="font-size:0.8em;color:var(--text-dim);display:none"></div>
          <div id="testGenResults" style="margin-top:8px;display:none">
            <div id="testGenImages" style="display:flex;flex-wrap:wrap;gap:10px"></div>
          </div>
        </div>
        <div class="field narrow">
          <label>Include Embed in Image Responses <span class="note">Shows internal View link; off by default</span></label>
          <select id="image_response_include_embed" data-env="IMAGE_RESPONSE_INCLUDE_EMBED" onchange="markDirty()">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Ollama Section -->
    <section>
      <h2 onclick="toggleSection(this)">Ollama</h2>
      <div class="body">
        <div class="field-row">
          <div class="field">
            <label>Ollama Endpoint</label>
            <input type="text" id="ollama_endpoint" data-env="OLLAMA_ENDPOINT" placeholder="http://localhost:11434">
          </div>
          <div class="field tiny">
            <button class="btn-test btn-sm" onclick="testConnection('ollama')">Test</button>
          </div>
        </div>
        <div class="field">
          <label>Ollama Model</label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            Select a model from the Ollama instance. Click <strong>Test</strong> above to refresh the model list.
          </p>
          <select id="ollama_model" data-env="OLLAMA_MODEL" onchange="markDirty()">
            <option value="">‚Äî click Test to load models ‚Äî</option>
          </select>
        </div>
        <div class="field">
          <label>
            System Prompt
            <span class="note">sets the bot's personality for all Ollama responses</span>
            <button class="btn-sm" style="margin-left:8px;font-size:0.85em;vertical-align:middle" onclick="resetSystemPrompt()">Reset to Default</button>
          </label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            When set, this prompt is included as the system message in all conversational Ollama responses, shaping the bot's tone and personality. Internal AI processes (keyword routing, context evaluation) always skip this prompt. Leave empty to send no system message ‚Äî the model responds based on its training defaults.
          </p>
          <textarea id="ollama_system_prompt" data-env="OLLAMA_SYSTEM_PROMPT" rows="4" style="width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.9em;font-family:inherit;resize:vertical" placeholder="You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate‚Äîif someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful."></textarea>
        </div>
        <hr style="border-color:var(--border);margin:16px 0">
        <div class="field">
          <label>
            Final Pass Model
            <span class="note">used when Final Pass is enabled on a keyword ‚Äî falls back to default model above</span>
          </label>
          <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">
            When a keyword has <strong>Final Pass</strong> checked, the API result is refined through Ollama using this model.
            Click <strong>Test</strong> above to populate the model list. Leave empty to use the default Ollama model.
          </p>
          <select id="ollama_final_pass_model" data-env="OLLAMA_FINAL_PASS_MODEL" onchange="markDirty()">
            <option value="">‚Äî use default model ‚Äî</option>
          </select>
        </div>
        <div class="field">
          <label>Final Pass Prompt <span class="note">AI instruction appended to every final pass refinement</span></label>
          <textarea id="ollama_final_pass_prompt" data-env="OLLAMA_FINAL_PASS_PROMPT" rows="3" placeholder="Keeping in character, review the incoming data and provide an opinionated response."></textarea>
          <button type="button" class="btn small" onclick="document.getElementById('ollama_final_pass_prompt').value='';markDirty();" title="Clear to use default prompt">Reset to Default</button>
        </div>
        <div class="field narrow">
          <label title="When enabled, the full abilities context sent to Ollama is logged in the status console">Detailed Ability Logging ‚ÑπÔ∏è</label>
          <select id="ability_logging_detailed" data-env="ABILITY_LOGGING_DETAILED" onchange="markDirty()">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
      </div>
    </section>

    <!-- AccuWeather Section -->
    <section>
      <h2 onclick="toggleSection(this)">AccuWeather API</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Get a free API key at <a href="https://developer.accuweather.com" target="_blank" style="color:var(--accent)">developer.accuweather.com</a>.
          The AccuWeather API provides current conditions and 5-day forecasts. Configure a default location so users can ask for weather without specifying a city.
        </p>
        <div class="field">
          <label>API Key <span class="note">write-only ‚Äî never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="accuweather_api_key" placeholder="Paste AccuWeather API key" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testConnection('accuweather')">Test</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Default Location <span class="note">city name or zip code used when user doesn't specify</span></label>
          <input type="text" id="accuweather_default_location" data-env="ACCUWEATHER_DEFAULT_LOCATION" placeholder="e.g. New York, 90210, or 349727">
        </div>
        <div class="field">
          <label>Default Weather Type <span class="note">what data to fetch when the weather keyword is used</span></label>
          <select id="accuweather_default_weather_type" data-env="ACCUWEATHER_DEFAULT_WEATHER_TYPE">
            <option value="full">Full (conditions + forecast)</option>
            <option value="current">Current conditions only</option>
            <option value="forecast">5-day forecast only</option>
          </select>
        </div>
        <div class="field">
          <label>Endpoint <span class="note">override only if using a proxy</span></label>
          <input type="text" id="accuweather_endpoint" data-env="ACCUWEATHER_ENDPOINT" placeholder="https://dataservice.accuweather.com">
        </div>
        <div id="accuweatherTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- NFL Section -->
    <section>
      <h2 onclick="toggleSection(this)">NFL API (ESPN)</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Powered by ESPN's public API ‚Äî no API key required.
          Provides live NFL scores and news. Use keywords <code style="color:var(--accent)">!nfl scores</code> (optionally with a date like <code style="color:var(--accent)">!nfl scores 20260208</code>) or <code style="color:var(--accent)">!nfl news</code> (optionally with a filter like <code style="color:var(--accent)">!nfl news draft</code>).
        </p>
        <div class="field">
          <label>Enabled</label>
          <select id="nfl_enabled" data-env="NFL_ENABLED">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
        <div class="field">
          <label>Endpoint <span class="note">override only if using a proxy</span></label>
          <input type="text" id="nfl_endpoint" data-env="NFL_BASE_URL" placeholder="https://site.api.espn.com/apis/site/v2/sports/football/nfl">
        </div>
        <div class="field narrow">
          <label title="Controls how much NFL API detail is written to logs. 0 = summary only, 1 = summary + trimmed preview, 2 = full payload">Logging Level ‚ÑπÔ∏è</label>
          <select id="nfl_logging_level" data-env="NFL_LOGGING_LEVEL" onchange="markDirty()">
            <option value="0">0 ‚Äî Summary</option>
            <option value="1">1 ‚Äî Preview</option>
            <option value="2">2 ‚Äî Full</option>
          </select>
        </div>
        <div id="nflTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- Meme Section -->
    <section>
      <h2 onclick="toggleSection(this)">Meme API (memegen.link)</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Powered by <a href="https://memegen.link" target="_blank" style="color:var(--accent)">memegen.link</a> ‚Äî free, no API key required.
          Templates are cached locally and refreshed every 7 days.
          Use keyword <code style="color:var(--accent)">!meme</code>.
        </p>
        <div class="field">
          <label>Enabled</label>
          <select id="meme_enabled" data-env="MEME_ENABLED">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
        <div class="field narrow">
          <label title="When enabled, meme inference logs include the full template prompt and parsed payload">Debug Logging ‚ÑπÔ∏è</label>
          <select id="meme_logging_debug" data-env="MEME_LOGGING_DEBUG" onchange="markDirty()">
            <option value="false">Off</option>
            <option value="true">On</option>
          </select>
        </div>
        <div id="memeTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- SerpAPI Section -->
    <section>
      <h2 onclick="toggleSection(this)">SerpAPI (Google Search)</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          Get a free API key at <a href="https://serpapi.com/" target="_blank" style="color:var(--accent)">serpapi.com</a>.
          Provides Google Search results including AI Overview, Knowledge Graph, and organic results.
          Use keywords <code style="color:var(--accent)">!search</code> or <code style="color:var(--accent)">!second opinion</code>.
        </p>
        <div class="field">
          <label>API Key <span class="note">write-only ‚Äî never displayed</span></label>
          <div class="field-row">
            <div class="field">
              <input type="password" id="serpapi_api_key" placeholder="Paste SerpAPI key" autocomplete="off">
            </div>
            <div class="field tiny">
              <button class="btn-test btn-sm" onclick="testConnection('serpapi')">Test</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label>Endpoint <span class="note">override only if using a proxy</span></label>
          <input type="text" id="serpapi_endpoint" data-env="SERPAPI_ENDPOINT" placeholder="https://serpapi.com">
        </div>
        <div class="field-row">
          <div class="field">
            <label>Language <span class="note">hl ‚Äî AI Overview requires <code style="color:var(--accent)">en</code></span></label>
            <input type="text" id="serpapi_hl" data-env="SERPAPI_HL" placeholder="en">
          </div>
          <div class="field">
            <label>Country <span class="note">gl ‚Äî limits AI Overview availability</span></label>
            <input type="text" id="serpapi_gl" data-env="SERPAPI_GL" placeholder="us">
          </div>
          <div class="field">
            <label>Location <span class="note">optional location hint (e.g. Austin,Texas)</span></label>
            <input type="text" id="serpapi_location" data-env="SERPAPI_LOCATION" placeholder="United States">
          </div>
        </div>
        <div id="serpapiTestResult" style="font-size:0.8em;margin-top:6px;color:var(--text-dim)"></div>
      </div>
    </section>

    <!-- Error Handling Section -->
    <section>
      <h2 onclick="toggleSection(this)">Error Handling</h2>
      <div class="body">
        <div class="field">
          <label>Error Message <span class="note">sent to Discord users when an error occurs</span></label>
          <input type="text" id="error_message" data-env="ERROR_MESSAGE" placeholder="I'm experiencing technical difficulties. Please try again later.">
        </div>
        <div class="field narrow">
          <label>Error Rate Limit (minutes) <span class="note">minimum time between error messages</span></label>
          <input type="number" id="error_rate_limit" data-env="ERROR_RATE_LIMIT_MINUTES" placeholder="60" min="1">
        </div>
      </div>
    </section>

    <!-- HTTP Server Section -->
    <section>
      <h2 onclick="toggleSection(this)">HTTP Server</h2>
      <div class="body">
        <p style="font-size:0.75em;color:var(--text-dim);margin-bottom:10px">
          The <strong>Configurator</strong> server is the admin interface you are using now (localhost-only by default).
          The <strong>Outputs</strong> server is a public-facing HTTP server that serves generated files (images, etc.) so Discord can fetch attachments.
          Changing any of these values requires a <strong>restart</strong>.
        </p>
        <p style="font-size:0.75em;color:var(--warn);margin-bottom:10px">
          Security note: this app does <strong>not</strong> terminate SSL/TLS. Use a trusted reverse SSL proxy for public inbound ports.
          Do <strong>not</strong> expose the configurator to the public internet without strict IP filtering and strong admin authentication.
        </p>
        <label style="display:block;font-size:0.85em;font-weight:600;margin-bottom:6px">Configurator (Admin)</label>
        <div class="field-row">
          <div class="field narrow">
            <label>Port <span class="note">restart</span></label>
            <input type="number" id="http_port" data-env="HTTP_PORT" placeholder="3000">
          </div>
          <div class="field">
            <label>Bind Host <span class="note">restart ¬∑ default 127.0.0.1 (localhost only)</span></label>
            <input type="text" id="http_host" data-env="HTTP_HOST" placeholder="127.0.0.1">
          </div>
        </div>
        <hr style="border-color:var(--border);margin:12px 0">
        <label style="display:block;font-size:0.85em;font-weight:600;margin-bottom:6px">Outputs (Public)</label>
        <div class="field-row">
          <div class="field narrow">
            <label>Port <span class="note">restart</span></label>
            <input type="number" id="outputs_port" data-env="OUTPUTS_PORT" placeholder="3003">
          </div>
          <div class="field">
            <label>Bind Host <span class="note">restart ¬∑ default 0.0.0.0 (all interfaces)</span></label>
            <input type="text" id="outputs_host" data-env="OUTPUTS_HOST" placeholder="0.0.0.0">
          </div>
        </div>
        <div class="field" style="margin-top:10px">
          <label>Output Base URL <span class="note">URL Discord uses to fetch files from the outputs server</span></label>
          <input type="text" id="output_base_url" data-env="OUTPUT_BASE_URL" placeholder="http://localhost:3003">
        </div>
        <div class="field narrow" style="margin-top:10px">
          <label>Outputs Trust Proxy <span class="note">restart ¬∑ false, true, or proxy hop count (e.g. 1)</span></label>
          <input type="text" id="outputs_trust_proxy" data-env="OUTPUTS_TRUST_PROXY" placeholder="false"
                 pattern="^(false|true|[1-9]\d*)$" title="Enter false, true, or a positive integer hop count">
        </div>
        <div class="field narrow" style="margin-top:10px">
          <label>Activity Key TTL (seconds) <span class="note">how long a key stays valid ¬∑ default 300</span></label>
          <input type="number" id="activity_key_ttl" data-env="ACTIVITY_KEY_TTL" placeholder="300" min="30">
        </div>
      </div>
    </section>

    <!-- Limits Section -->
    <section>
      <h2 onclick="toggleSection(this)">Limits</h2>
      <div class="body">
        <div class="field-row">
          <div class="field">
            <label>File Size Threshold (bytes)</label>
            <input type="number" id="file_size_threshold" data-env="FILE_SIZE_THRESHOLD" placeholder="10485760">
          </div>
          <div class="field narrow">
            <label>Default Timeout (sec)</label>
            <input type="number" id="default_timeout" data-env="DEFAULT_TIMEOUT" placeholder="300">
          </div>
        </div>
        <div class="field narrow">
          <label>Max Attachments per Message <span class="note">1‚Äì10, Discord limit is 10</span></label>
          <input type="number" id="max_attachments" data-env="MAX_ATTACHMENTS" placeholder="10" min="1" max="10">
        </div>
      </div>
    </section>
    <!-- Reply Chain Section -->
    <section>
      <h2 onclick="toggleSection(this)">Reply Chain Context</h2>
      <div class="body">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          When enabled, the bot collects conversation history for Ollama. In servers, this traverses reply chains.
          In <strong>DMs</strong>, recent messages are included automatically without requiring explicit replies.
        </p>
        <div class="field-row">
          <div class="field narrow">
            <label>Enabled</label>
            <select id="reply_chain_enabled" data-env="REPLY_CHAIN_ENABLED" onchange="markDirty()">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field narrow">
            <label>Max Depth <span class="note">1‚Äì50 messages</span></label>
            <input type="number" id="reply_chain_max_depth" data-env="REPLY_CHAIN_MAX_DEPTH" placeholder="10" min="1" max="50">
          </div>
          <div class="field narrow">
            <label>Max Tokens <span class="note">1,000‚Äì128,000 chars</span></label>
            <input type="number" id="reply_chain_max_tokens" data-env="REPLY_CHAIN_MAX_TOKENS" placeholder="16000" min="1000" max="128000">
          </div>
          <div class="field narrow">
            <label>Image Max Depth <span class="note">0‚Äì50 messages</span></label>
            <input type="number" id="reply_chain_image_max_depth" data-env="REPLY_CHAIN_IMAGE_MAX_DEPTH" placeholder="5" min="0" max="50">
          </div>
        </div>
      </div>
    </section>
    <!-- Message Flow Section -->
    <section>
      <h2 onclick="toggleSection(this)">Message Flow Overview</h2>
      <div class="body">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          How the bot processes an incoming @mention or DM.
        </p>
        <pre class="mermaid" style="background:transparent;text-align:center">
flowchart LR
    A["üì® Message"] --> B{"!api\nkeyword?"}
    B -->|Yes| D["‚ö° Route to API"]
    B -->|No| CF["üîç Context Filter\n(if enabled)"]
    CF --> C["üß† Ollama Chat\n(with abilities)"]
    C -->|"Ability detected"| IP["üß† Infer Params\n(if needed)"]
    IP --> D
    C -->|"No ability"| F["üí¨ Direct Reply"]
    D --> R{"‚ùå Failed?"}
    R -->|"Yes &\nretry on"| RT["üîÑ Retry\n(refine params)"]
    RT --> D
    R -->|No| E{"üîÑ Final\nPass?"}
    E -->|Yes| G["üß† Ollama\nRefinement"]
    E -->|No| H["üì§ Response"]
    G --> H
    F --> H
        </pre>
      </div>
    </section>
    <!-- Keywords Section -->
    <section>
      <h2 class="open" onclick="toggleSection(this)">Keywords ‚Üí API Routing</h2>
      <div class="body open">
        <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px">
          Map @mention keywords to APIs. Keywords must start with <code>!</code> (e.g. <code>!weather</code>).
          When <strong>Ability</strong> is checked, the keyword's description is included
          as context so Ollama can suggest using that API even when the keyword isn't typed explicitly.
          <strong>Final Pass</strong> sends the API result back through Ollama for conversational refinement.
        </p>
        <table class="kw-table">
          <thead>
            <tr>
              <th style="text-align:center" title="Enable or disable this keyword">On</th>
              <th>Keyword</th>
              <th>API</th>
              <th title="Request timeout in seconds">Timeout (s)</th>
              <th title="Human-readable description; used as ability context when Ability is checked">Description</th>
              <th title="When checked, this keyword's description is included in Ollama's abilities context so it can suggest using this API without the keyword being typed" style="text-align:center">Ability ‚ÑπÔ∏è</th>
              <th title="When checked, the API result is passed through Ollama for conversational refinement using the global Final Pass Model" style="text-align:center">Final Pass ‚ÑπÔ∏è</th>
              <th title="When checked, Ollama context evaluation is applied before building the two-stage prompt" style="text-align:center">Ctx Eval ‚ÑπÔ∏è</th>
              <th title="Per-keyword min/max depth overrides for Ollama context evaluation" style="text-align:center">Ctx Depth ‚ÑπÔ∏è</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="kwBody"></tbody>
        </table>
        <div style="margin-top:10px">
          <button class="btn-secondary btn-sm" onclick="addKeywordRow()">+ Add Keyword</button>
          <button class="btn-secondary btn-sm" id="syncDefaultsBtn" style="margin-left:8px;display:none" onclick="syncMissingDefaults()">+ Add Missing Defaults</button>
          <button class="btn-secondary btn-sm" style="margin-left:8px" onclick="downloadToolsXml()">Download XML</button>
          <button class="btn-secondary btn-sm" style="margin-left:8px" onclick="restoreDefaultKeywords()">Restore Defaults</button>
          <span id="syncDefaultsInfo" style="font-size:0.75em;color:var(--text-dim);margin-left:8px"></span>
        </div>
      </div>
    </section>

  </div>

  <!-- Console Panel (bottom strip) -->
  <div class="console-panel">
    <div class="console-panel-header" onclick="openLogModal()">
      <span>Status Console</span>
      <span class="hint">click to expand</span>
    </div>
    <div id="console"></div>
  </div>
</div>

<!-- Log Modal (expanded viewer) -->
<div class="log-modal-backdrop" id="logModalBackdrop" onclick="closeLogModal()"></div>
<div class="log-modal" id="logModal">
  <div class="log-modal-header">
    <h3>Status Console ‚Äî Full Log</h3>
    <button class="log-modal-close" onclick="closeLogModal()" title="Close (Esc)">‚úï</button>
  </div>
  <div class="log-modal-body" id="logModalBody"></div>
</div>

<!-- Bottom action bar -->
<div class="actions-bar">
  <button class="btn-secondary btn-sm" onclick="loadConfig()">‚Üª Reload</button>
  <button class="btn-secondary btn-sm" onclick="rotateLog()" title="Archive current log and start fresh">üîÑ Rotate Log</button>
  <button class="btn-secondary btn-sm" id="btnGenKey" onclick="generateActivityKey()">üîë Activity Key</button>
  <span id="activityKeyResult"></span>
  <span class="spacer"></span>
  <span class="msg" id="saveMsg"></span>
  <button class="btn-primary" id="saveBtn" disabled onclick="saveConfig()">Save Changes</button>
</div>

<script>
  mermaid.initialize({ startOnLoad: false, theme: 'dark', themeVariables: { primaryColor: '#0f3460', primaryTextColor: '#eee', lineColor: '#e94560', secondaryColor: '#533483' } });
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let originalConfig = null;
  let dirty = false;
  let _serverTheme = 'dark'; // Theme loaded from server (.env)

  // ‚îÄ‚îÄ Section toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleSection(h2) {
    h2.classList.toggle('open');
    h2.nextElementSibling.classList.toggle('open');
    // Render any un-rendered Mermaid diagrams when section opens
    if (h2.classList.contains('open')) {
      const diagrams = h2.nextElementSibling.querySelectorAll('pre.mermaid:not([data-processed])');
      if (diagrams.length) mermaid.run({ nodes: Array.from(diagrams) });
    }
  }

  // ‚îÄ‚îÄ Console ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const consoleEl = document.getElementById('console');

  function conLog(text, cls = '') {
    const d = document.createElement('div');
    d.className = 'line' + (cls ? ' ' + cls : '');
    d.textContent = text;
    consoleEl.appendChild(d);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  async function pollStatus() {
    try {
      const res = await fetch('/api/config/status');
      const data = await res.json();
      consoleEl.innerHTML = '';
      for (const line of data.lines) {
        const cls = classifyLine(line);
        conLog(line, cls);
      }
    } catch (e) {
      // server not reachable
    }
  }

  // ‚îÄ‚îÄ Bot status polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function pollBotStatus() {
    try {
      const res = await fetch('/api/discord/status');
      const data = await res.json();
      updateBotUI(data);
    } catch (e) {
      updateBotUI({ status: 'stopped', username: null, error: null, tokenConfigured: false });
    }
  }

  function updateBotUI(data) {
    const dot = document.getElementById('botDot');
    const text = document.getElementById('botStatusText');
    const headerDot = document.getElementById('statusDot');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');

    dot.className = 'dot ' + data.status;

    switch (data.status) {
      case 'running':
        text.textContent = `Connected as ${data.username || '?'}`;
        headerDot.className = 'dot';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'connecting':
        text.textContent = 'Connecting‚Ä¶';
        headerDot.className = 'dot warn';
        btnStart.disabled = true;
        btnStop.disabled = false;
        break;
      case 'error':
        text.textContent = `Error: ${data.error || 'unknown'}`;
        headerDot.className = 'dot off';
        btnStart.disabled = false;
        btnStop.disabled = true;
        break;
      default:
        text.textContent = data.tokenConfigured ? 'Stopped' : 'Stopped ‚Äî no token configured';
        headerDot.className = 'dot off';
        btnStart.disabled = !data.tokenConfigured;
        btnStop.disabled = true;
    }
  }

  // ‚îÄ‚îÄ Dirty tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function markDirty() {
    dirty = true;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('saveMsg').textContent = 'Unsaved changes';
    document.getElementById('saveMsg').className = 'msg warn';
  }

  function markClean() {
    dirty = false;
    document.getElementById('saveBtn').disabled = true;
  }

  // Attach to all env inputs + token field
  function attachDirtyListeners() {
    document.querySelectorAll('[data-env]').forEach(input => {
      input.addEventListener('input', () => {
        input.classList.add('dirty');
        markDirty();
      });
    });
    document.getElementById('discord_token').addEventListener('input', () => {
      if (document.getElementById('discord_token').value.trim()) {
        markDirty();
      }
    });
  }

  // ‚îÄ‚îÄ System prompt reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const DEFAULT_SYSTEM_PROMPT = "You are a helpful Discord bot assistant. Be friendly and helpful by default, but match the user's tone when appropriate\u2014if someone is being snarky or playful, feel free to respond in kind. Always prioritize being useful and respectful.";

  function resetSystemPrompt() {
    const el = document.getElementById('ollama_system_prompt');
    el.value = DEFAULT_SYSTEM_PROMPT;
    el.classList.add('dirty');
    markDirty();
  }

  // ‚îÄ‚îÄ Load config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const cfg = await res.json();
      originalConfig = cfg;

      // Populate env fields
      document.getElementById('discord_client_id').value = cfg.discord.clientId;
      document.getElementById('comfyui_endpoint').value = cfg.apis.comfyui;
      document.getElementById('ollama_endpoint').value = cfg.apis.ollama;
      document.getElementById('http_port').value = cfg.http.port;
      document.getElementById('http_host').value = cfg.http.httpHost || '';
      document.getElementById('outputs_port').value = cfg.http.outputsPort;
      document.getElementById('outputs_host').value = cfg.http.outputsHost || '';
      document.getElementById('outputs_trust_proxy').value = cfg.http.outputsTrustProxy || 'false';
      document.getElementById('output_base_url').value = cfg.http.outputBaseUrl;
      document.getElementById('file_size_threshold').value = cfg.limits.fileSizeThreshold;
      document.getElementById('default_timeout').value = cfg.limits.defaultTimeout;
      document.getElementById('max_attachments').value = cfg.limits.maxAttachments;

      // Populate Ollama model (saved selection)
      const modelSelect = document.getElementById('ollama_model');
      if (cfg.apis.ollamaModel) {
        // Ensure the saved model is in the dropdown
        const exists = Array.from(modelSelect.options).some(o => o.value === cfg.apis.ollamaModel);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = cfg.apis.ollamaModel;
          opt.textContent = cfg.apis.ollamaModel + ' (saved)';
          modelSelect.appendChild(opt);
        }
        modelSelect.value = cfg.apis.ollamaModel;
      }

      // Populate ComfyUI workflow status
      const workflowStatus = document.getElementById('workflowStatus');
      _hasCustomWorkflow = !!cfg.apis.comfyuiWorkflowConfigured;
      if (_hasCustomWorkflow) {
        workflowStatus.innerHTML = '<span style="color:var(--ok)">‚úì Workflow configured</span>';
        document.getElementById('customWorkflowActions').style.display = '';
      } else {
        workflowStatus.innerHTML = '<span style="color:var(--text-dim)">No workflow uploaded</span>';
        document.getElementById('customWorkflowActions').style.display = 'none';
      }

      // Populate default workflow settings
      if (cfg.defaultWorkflow) {
        const dw = cfg.defaultWorkflow;
        if (dw.model) {
          const modelSelect = document.getElementById('dw_model');
          const exists = Array.from(modelSelect.options).some(o => o.value === dw.model);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.model;
            opt.textContent = dw.model + ' (saved)';
            modelSelect.appendChild(opt);
          }
          modelSelect.value = dw.model;
        }
        document.getElementById('dw_width').value = dw.width || 512;
        document.getElementById('dw_height').value = dw.height || 512;
        document.getElementById('dw_steps').value = dw.steps || 20;
        document.getElementById('dw_cfg').value = dw.cfg || 7.0;
        if (dw.sampler) {
          const samplerSelect = document.getElementById('dw_sampler');
          const exists = Array.from(samplerSelect.options).some(o => o.value === dw.sampler);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.sampler;
            opt.textContent = dw.sampler;
            samplerSelect.appendChild(opt);
          }
          samplerSelect.value = dw.sampler;
        }
        if (dw.scheduler) {
          const schedulerSelect = document.getElementById('dw_scheduler');
          const exists = Array.from(schedulerSelect.options).some(o => o.value === dw.scheduler);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = dw.scheduler;
            opt.textContent = dw.scheduler;
            schedulerSelect.appendChild(opt);
          }
          schedulerSelect.value = dw.scheduler;
        }
        document.getElementById('dw_denoise').value = typeof dw.denoise === 'number' ? dw.denoise : 1.0;
        document.getElementById('dw_seed').value = typeof dw.seed === 'number' ? dw.seed : -1;
      }
      updateDefaultWorkflowInfo();

      // Populate Ollama system prompt
      const systemPromptEl = document.getElementById('ollama_system_prompt');
      if (cfg.apis.ollamaSystemPrompt) {
        systemPromptEl.value = cfg.apis.ollamaSystemPrompt;
      }

      // Populate Ollama final pass prompt
      document.getElementById('ollama_final_pass_prompt').value = cfg.apis.ollamaFinalPassPrompt || '';

      // Populate AccuWeather fields
      document.getElementById('accuweather_default_location').value = cfg.apis.accuweatherDefaultLocation || '';
      document.getElementById('accuweather_endpoint').value = cfg.apis.accuweather || '';
      document.getElementById('accuweather_default_weather_type').value = cfg.apis.accuweatherDefaultWeatherType || 'full';
      document.getElementById('accuweather_api_key').value = '';
      document.getElementById('accuweather_api_key').placeholder =
        cfg.apis.accuweatherApiKeyConfigured ? 'API key configured ‚úì ‚Äî paste new value to change' : 'Paste AccuWeather API key';

      // Populate NFL fields
      document.getElementById('nfl_enabled').value = cfg.apis.nflEnabled ? 'true' : 'false';
      document.getElementById('nfl_endpoint').value = cfg.apis.nfl || '';
      document.getElementById('meme_enabled').value = cfg.apis.memeEnabled ? 'true' : 'false';
      document.getElementById('meme_logging_debug').value = cfg.memeLogging?.debug ? 'true' : 'false';

      // Populate SerpAPI fields
      document.getElementById('serpapi_endpoint').value = cfg.apis.serpapi || '';
      document.getElementById('serpapi_hl').value = cfg.apis.serpapiHl ?? 'en';
      document.getElementById('serpapi_gl').value = cfg.apis.serpapiGl ?? 'us';
      document.getElementById('serpapi_location').value = cfg.apis.serpapiLocation || '';
      document.getElementById('serpapi_api_key').value = '';
      document.getElementById('serpapi_api_key').placeholder =
        cfg.apis.serpapiApiKeyConfigured ? 'API key configured ‚úì ‚Äî paste new value to change' : 'Paste SerpAPI key';

      // Populate NFL logging level
      const nflLogLevel = document.getElementById('nfl_logging_level');
      nflLogLevel.value = String(cfg.nflLogging?.level ?? 1);

      // Populate error handling fields
      document.getElementById('error_message').value = cfg.errorHandling?.errorMessage || '';
      document.getElementById('error_rate_limit').value = cfg.errorHandling?.errorRateLimitMinutes || 60;

      // Populate reply chain fields
      const rcEnabled = document.getElementById('reply_chain_enabled');
      rcEnabled.value = cfg.replyChain?.enabled === false ? 'false' : 'true';
      document.getElementById('reply_chain_max_depth').value = cfg.replyChain?.maxDepth || 10;
      document.getElementById('reply_chain_max_tokens').value = cfg.replyChain?.maxTokens || 16000;
      document.getElementById('reply_chain_image_max_depth').value = cfg.replyChain?.imageMaxDepth ?? 5;

      // Populate ability logging
      const alDetailed = document.getElementById('ability_logging_detailed');
      alDetailed.value = cfg.abilityLogging?.detailed ? 'true' : 'false';

      // Populate Final Pass Model (saved selection)
      const fpModelSelect = document.getElementById('ollama_final_pass_model');
      if (cfg.apis.ollamaFinalPassModel && cfg.apis.ollamaFinalPassModel !== cfg.apis.ollamaModel) {
        const exists = Array.from(fpModelSelect.options).some(o => o.value === cfg.apis.ollamaFinalPassModel);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = cfg.apis.ollamaFinalPassModel;
          opt.textContent = cfg.apis.ollamaFinalPassModel + ' (saved)';
          fpModelSelect.appendChild(opt);
        }
        fpModelSelect.value = cfg.apis.ollamaFinalPassModel;
      }

      // Populate image response setting
      const irEmbed = document.getElementById('image_response_include_embed');
      irEmbed.value = cfg.imageResponse?.includeEmbed ? 'true' : 'false';

      // Bot Display Name
      document.getElementById('bot_display_name').value = cfg.discord.botDisplayName || '';

      // Token field is always empty (write-only) ‚Äî just show placeholder
      document.getElementById('discord_token').value = '';
      document.getElementById('discord_token').placeholder =
        cfg.discord.tokenConfigured ? 'Token configured ‚úì ‚Äî paste new value to change' : 'Paste Discord bot token here';

      // Populate keywords
      renderKeywords(cfg.keywords);

      // Check for missing default keywords and show sync button if needed
      checkMissingDefaults(cfg.keywords, cfg.defaultKeywords || []);

      // Apply server-side theme preference
      if (cfg.configuratorTheme) {
        _serverTheme = cfg.configuratorTheme;
        applyTheme(cfg.configuratorTheme, /* fromServer */ true);
      }

      // Clear dirty state
      document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
      markClean();
      document.getElementById('saveMsg').textContent = 'Config loaded';
      document.getElementById('saveMsg').className = 'msg ok';
      document.getElementById('statusDot').className = 'dot';

      conLog(`[${new Date().toISOString()}] Config loaded from server`, 'ok');
    } catch (e) {
      document.getElementById('statusDot').className = 'dot off';
      conLog(`[${new Date().toISOString()}] Failed to load config: ${e.message}`, 'err');
    }
  }

  // ‚îÄ‚îÄ Keywords table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderKeywords(keywords) {
    const tbody = document.getElementById('kwBody');
    tbody.innerHTML = '';
    for (const kw of keywords) {
      addKeywordRow(kw);
    }
  }

  function addKeywordRow(kw = null) {
    const tbody = document.getElementById('kwBody');
    const tr = document.createElement('tr');
    const isBuiltin = !!kw?.builtin;
    const isEnabled = kw ? kw.enabled !== false : true;
    if (isBuiltin) tr.classList.add('kw-builtin');
    tr.dataset.builtin = isBuiltin ? '1' : '';

    // Derive detail-field values
    const ai = kw?.abilityInputs || {};
    const retry = kw?.retry || {};
    tr.innerHTML = `
      <td style="text-align:center"><input type="checkbox" class="kw-enabled" ${isEnabled ? 'checked' : ''} title="${isBuiltin ? 'Enable or disable this built-in keyword' : 'Enable or disable this keyword'}"></td>
      <td><input type="text" class="kw-keyword" value="${esc(kw?.keyword || '')}" placeholder="!keyword">${isBuiltin ? '<span class="kw-builtin-badge">built-in</span>' : ''}</td>
      <td><select class="kw-api">
        <option value="comfyui" ${kw?.api === 'comfyui' ? 'selected' : ''}>comfyui</option>
        <option value="ollama" ${kw?.api === 'ollama' ? 'selected' : ''}>ollama</option>
        <option value="accuweather" ${kw?.api === 'accuweather' ? 'selected' : ''}>accuweather</option>
        <option value="nfl" ${kw?.api === 'nfl' ? 'selected' : ''}>nfl</option>
        <option value="serpapi" ${kw?.api === 'serpapi' ? 'selected' : ''}>serpapi</option>
        <option value="meme" ${kw?.api === 'meme' ? 'selected' : ''}>meme</option>
      </select></td>
      <td><input type="number" class="kw-timeout" value="${kw?.timeout || 300}" style="width:70px"></td>
      <td><input type="text" class="kw-desc" value="${esc(kw?.description || '')}" placeholder="description"></td>
      <td style="text-align:center"><input type="checkbox" class="kw-ability" ${kw?.abilityText ? 'checked' : ''} title="Include this keyword as an ability in Ollama context"></td>
      <td style="text-align:center"><input type="checkbox" class="kw-finalPass" ${kw?.finalOllamaPass ? 'checked' : ''} title="Pass API result through Ollama for conversational refinement"></td>
      <td style="text-align:center"><input type="checkbox" class="kw-ctxEval" ${kw?.contextFilterEnabled ? 'checked' : ''} title="Enable Ollama context evaluation for this keyword"></td>
      <td style="text-align:center">
        <span class="kw-ctx-depth kw-ctx-depth-stacked">
          <span class="kw-ctx-row"><span class="kw-ctx-label">Min</span> <input type="number" class="kw-ctxMin" value="${kw?.contextFilterMinDepth ?? ''}" min="1" style="width:50px" title="Min depth ‚Äî always included (default: 1)" placeholder="1"></span>
          <span class="kw-ctx-row"><span class="kw-ctx-label">Max</span> <input type="number" class="kw-ctxMax" value="${kw?.contextFilterMaxDepth ?? ''}" min="1" style="width:50px" title="Max depth ‚Äî max messages eligible (default: global reply chain max)" placeholder="auto"></span>
        </span>
      </td>
      <td>${isBuiltin ? '' : '<button class="btn-danger btn-sm" onclick="removeKeywordRow(this)">‚úï</button>'}</td>
      <td><button class="kw-expand-btn" title="Show/hide advanced fields" onclick="toggleKwDetails(this)">‚ñ∏</button></td>
    `;

    // Details row
    const detailTr = document.createElement('tr');
    detailTr.className = 'kw-details-row';
    const colCount = tr.children.length;
    detailTr.innerHTML = `
      <td colspan="${colCount}">
        <div class="kw-details-grid">
          <div class="section-label">Ability</div>
          <div class="field-full">
            <label>Ability Text <span style="color:var(--text-dim);font-weight:normal">(model-facing description; leave empty to use Description)</span></label>
            <input type="text" class="kw-abilityText" value="${esc(kw?.abilityText || '')}" placeholder="(uses description)">
          </div>
          <div class="field-full">
            <label>Ability When <span style="color:var(--text-dim);font-weight:normal">(when the model should pick this ability)</span></label>
            <input type="text" class="kw-abilityWhen" value="${esc(kw?.abilityWhen || '')}" placeholder="e.g. User asks about weather">
          </div>

          <div class="section-label">Parameters</div>
          <div class="field-half">
            <label>Allow Empty Content</label>
            <select class="kw-allowEmpty">
              <option value="" ${kw?.allowEmptyContent === undefined ? 'selected' : ''}>default (requires content)</option>
              <option value="true" ${kw?.allowEmptyContent === true ? 'selected' : ''}>yes ‚Äî works standalone</option>
              <option value="false" ${kw?.allowEmptyContent === false ? 'selected' : ''}>no ‚Äî requires content</option>
            </select>
          </div>
          <div class="field-half">
            <label>Inputs Mode</label>
            <select class="kw-aiMode">
              <option value="" ${!ai.mode ? 'selected' : ''}>none</option>
              <option value="explicit" ${ai.mode === 'explicit' ? 'selected' : ''}>explicit</option>
              <option value="implicit" ${ai.mode === 'implicit' ? 'selected' : ''}>implicit</option>
              <option value="mixed" ${ai.mode === 'mixed' ? 'selected' : ''}>mixed</option>
            </select>
          </div>
          <div class="field-half">
            <label>Required Inputs <span style="color:var(--text-dim);font-weight:normal">(comma-separated)</span></label>
            <input type="text" class="kw-aiRequired" value="${esc((ai.required || []).join(', '))}" placeholder="e.g. location">
          </div>
          <div class="field-half">
            <label>Optional Inputs <span style="color:var(--text-dim);font-weight:normal">(comma-separated)</span></label>
            <input type="text" class="kw-aiOptional" value="${esc((ai.optional || []).join(', '))}" placeholder="e.g. date">
          </div>
          <div class="field-half">
            <label>Infer From <span style="color:var(--text-dim);font-weight:normal">(comma-separated)</span></label>
            <input type="text" class="kw-aiInferFrom" value="${esc((ai.inferFrom || []).join(', '))}" placeholder="e.g. current_message, reply_target">
          </div>
          <div class="field-full">
            <label>Validation <span style="color:var(--text-dim);font-weight:normal">(constraint description for the model)</span></label>
            <input type="text" class="kw-aiValidation" value="${esc(ai.validation || '')}" placeholder="e.g. Must be a city name or postal code">
          </div>
          <div class="field-full">
            <label>Examples <span style="color:var(--text-dim);font-weight:normal">(comma-separated)</span></label>
            <input type="text" class="kw-aiExamples" value="${esc((ai.examples || []).join(', '))}" placeholder="e.g. weather Dallas, weather 90210">
          </div>

          <div class="section-label">Retry</div>
          <div class="field-half">
            <label>Retry Enabled</label>
            <select class="kw-retryEnabled">
              <option value="" ${retry.enabled === undefined ? 'selected' : ''}>default (global)</option>
              <option value="true" ${retry.enabled === true ? 'selected' : ''}>yes</option>
              <option value="false" ${retry.enabled === false ? 'selected' : ''}>no</option>
            </select>
          </div>
          <div class="field-half">
            <label>Max Retries <span style="color:var(--text-dim);font-weight:normal">(0‚Äì10)</span></label>
            <input type="number" class="kw-retryMax" value="${retry.maxRetries ?? ''}" min="0" max="10" placeholder="default">
          </div>
          <div class="field-half">
            <label>Retry Model</label>
            <input type="text" class="kw-retryModel" value="${esc(retry.model || '')}" placeholder="default">
          </div>
          <div class="field-full">
            <label>Retry Prompt</label>
            <input type="text" class="kw-retryPrompt" value="${esc(retry.prompt || '')}" placeholder="default (global)">
          </div>
        </div>
      </td>
    `;

    // Attach dirty listeners to both rows
    [tr, detailTr].forEach(row => {
      row.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('input', markDirty);
        el.addEventListener('change', markDirty);
      });
    });

    // Link the two rows
    tr._detailRow = detailTr;
    detailTr._mainRow = tr;

    // Add visual separator between keyword entries (skip the first row)
    if (tbody.children.length > 0) {
      tr.classList.add('kw-separator-top');
    }

    tbody.appendChild(tr);
    tbody.appendChild(detailTr);
  }

  function toggleKwDetails(btn) {
    const mainRow = btn.closest('tr');
    const detailRow = mainRow._detailRow;
    if (!detailRow) return;
    const isOpen = detailRow.classList.toggle('open');
    btn.textContent = isOpen ? '‚ñæ' : '‚ñ∏';
  }

  function removeKeywordRow(btn) {
    const mainRow = btn.closest('tr');
    const detailRow = mainRow._detailRow;
    if (detailRow) detailRow.remove();
    mainRow.remove();
    markDirty();
  }

  // ‚îÄ‚îÄ Missing defaults detection / sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _cachedDefaultKeywords = [];

  function checkMissingDefaults(currentKeywords, defaultKeywords) {
    _cachedDefaultKeywords = defaultKeywords || [];
    const currentKeys = new Set(currentKeywords.map(k => k.keyword.toLowerCase()));
    const missing = _cachedDefaultKeywords.filter(d => !currentKeys.has(d.keyword.toLowerCase()));
    const btn = document.getElementById('syncDefaultsBtn');
    const info = document.getElementById('syncDefaultsInfo');
    if (missing.length > 0) {
      btn.style.display = '';
      info.textContent = `${missing.length} keyword(s) in defaults not in your config: ${missing.map(m => m.keyword).join(', ')}`;
    } else {
      btn.style.display = 'none';
      info.textContent = '';
    }
  }

  function syncMissingDefaults() {
    const currentKeywords = collectKeywords();
    const currentKeys = new Set(currentKeywords.map(k => k.keyword.toLowerCase()));
    const missing = _cachedDefaultKeywords.filter(d => !currentKeys.has(d.keyword.toLowerCase()));
    for (const kw of missing) {
      addKeywordRow(kw);
    }
    markDirty();
    const btn = document.getElementById('syncDefaultsBtn');
    const info = document.getElementById('syncDefaultsInfo');
    btn.style.display = 'none';
    info.textContent = `Added ${missing.length} keyword(s) ‚Äî save to persist`;
    info.style.color = 'var(--ok)';
    conLog(`[${new Date().toISOString()}] Synced ${missing.length} missing default keyword(s): ${missing.map(m => m.keyword).join(', ')}`, 'ok');
  }

  function downloadToolsXml() {
    const keywords = collectKeywords();
    let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<tools>\n';
    for (const kw of keywords) {
      xml += '  <tool>\n';
      xml += `    <name>${escXml(kw.keyword)}</name>\n`;
      xml += `    <api>${escXml(kw.api)}</api>\n`;
      xml += `    <timeout>${kw.timeout}</timeout>\n`;
      if (kw.description) xml += `    <description>${escXml(kw.description)}</description>\n`;
      if (kw.builtin) xml += '    <builtin>true</builtin>\n';
      if (kw.enabled === false) xml += '    <enabled>false</enabled>\n';
      if (kw.finalOllamaPass) xml += '    <finalOllamaPass>true</finalOllamaPass>\n';
      if (kw.contextFilterEnabled) xml += '    <contextFilterEnabled>true</contextFilterEnabled>\n';
      if (kw.contextFilterMinDepth) xml += `    <contextFilterMinDepth>${kw.contextFilterMinDepth}</contextFilterMinDepth>\n`;
      if (kw.contextFilterMaxDepth) xml += `    <contextFilterMaxDepth>${kw.contextFilterMaxDepth}</contextFilterMaxDepth>\n`;
      if (kw.allowEmptyContent === true) xml += '    <allowEmptyContent>true</allowEmptyContent>\n';
      else if (kw.allowEmptyContent === false) xml += '    <allowEmptyContent>false</allowEmptyContent>\n';
      if (kw.abilityText) xml += `    <abilityText>${escXml(kw.abilityText)}</abilityText>\n`;
      if (kw.abilityWhen) xml += `    <abilityWhen>${escXml(kw.abilityWhen)}</abilityWhen>\n`;
      if (kw.abilityInputs) {
        xml += '    <parameters>\n';
        xml += `      <mode>${escXml(kw.abilityInputs.mode)}</mode>\n`;
        if (kw.abilityInputs.required) {
          for (const p of kw.abilityInputs.required) {
            xml += `      <${escXml(p)}>\n        <type>string</type>\n        <required>true</required>\n      </${escXml(p)}>\n`;
          }
        }
        if (kw.abilityInputs.optional) {
          for (const p of kw.abilityInputs.optional) {
            xml += `      <${escXml(p)}>\n        <type>string</type>\n        <required>false</required>\n      </${escXml(p)}>\n`;
          }
        }
        if (kw.abilityInputs.inferFrom) xml += `      <inferFrom>${kw.abilityInputs.inferFrom.join(', ')}</inferFrom>\n`;
        if (kw.abilityInputs.validation) xml += `      <validation>${escXml(kw.abilityInputs.validation)}</validation>\n`;
        if (kw.abilityInputs.examples) {
          xml += '      <examples>\n';
          for (const ex of kw.abilityInputs.examples) xml += `        <example>${escXml(ex)}</example>\n`;
          xml += '      </examples>\n';
        }
        xml += '    </parameters>\n';
      }
      if (kw.retry) {
        xml += '    <retry>\n';
        if (kw.retry.enabled !== undefined) xml += `      <enabled>${kw.retry.enabled}</enabled>\n`;
        if (kw.retry.maxRetries !== undefined) xml += `      <maxRetries>${kw.retry.maxRetries}</maxRetries>\n`;
        if (kw.retry.model) xml += `      <model>${escXml(kw.retry.model)}</model>\n`;
        if (kw.retry.prompt) xml += `      <prompt>${escXml(kw.retry.prompt)}</prompt>\n`;
        xml += '    </retry>\n';
      }
      xml += '  </tool>\n';
    }
    xml += '</tools>\n';
    const blob = new Blob([xml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tools.xml';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    conLog(`[${new Date().toISOString()}] Downloaded tools.xml from configurator table`, 'ok');
  }

  function restoreDefaultKeywords() {
    if (!_cachedDefaultKeywords || _cachedDefaultKeywords.length === 0) {
      conLog(`[${new Date().toISOString()}] Restore defaults failed: no defaults available`, 'warn');
      return;
    }

    if (!confirm('Replace current keyword rows with defaults? This updates the table now; click Save Changes to persist.')) {
      return;
    }

    // Deep clone defaults to avoid mutating cached source objects.
    const restored = JSON.parse(JSON.stringify(_cachedDefaultKeywords));
    renderKeywords(restored);
    checkMissingDefaults(restored, _cachedDefaultKeywords);
    markDirty();

    const info = document.getElementById('syncDefaultsInfo');
    info.textContent = `Restored ${restored.length} default keyword(s) ‚Äî save to persist`;
    info.style.color = 'var(--ok)';
    conLog(`[${new Date().toISOString()}] Restored keyword table from defaults (${restored.length} entries)`, 'ok');
  }

  function collectKeywords() {
    const rows = document.querySelectorAll('#kwBody tr:not(.kw-details-row)');
    const keywords = [];
    for (const row of rows) {
      const keyword = row.querySelector('.kw-keyword')?.value?.trim();
      if (!keyword) continue;
      const isBuiltin = row.dataset.builtin === '1';
      const isEnabled = row.querySelector('.kw-enabled').checked;
      const entry = {
        keyword,
        api: row.querySelector('.kw-api').value,
        timeout: parseInt(row.querySelector('.kw-timeout').value, 10) || 300,
        description: row.querySelector('.kw-desc').value.trim() || keyword,
      };

      // Main row fields
      const isAbility = row.querySelector('.kw-ability').checked;
      const finalPass = row.querySelector('.kw-finalPass').checked;
      if (finalPass) entry.finalOllamaPass = true;
      const ctxEval = row.querySelector('.kw-ctxEval').checked;
      if (ctxEval) entry.contextFilterEnabled = true;
      const minD = parseInt(row.querySelector('.kw-ctxMin').value, 10);
      const maxD = parseInt(row.querySelector('.kw-ctxMax').value, 10);
      if (!isNaN(minD) && minD >= 1) entry.contextFilterMinDepth = minD;
      if (!isNaN(maxD) && maxD >= 1) entry.contextFilterMaxDepth = maxD;
      if (isBuiltin) entry.builtin = true;
      if (!isEnabled) entry.enabled = false;

      // Detail row fields
      const detail = row._detailRow;
      if (detail) {
        // abilityText: use explicit field if set, else if Ability checkbox is on use description
        const abilityTextVal = detail.querySelector('.kw-abilityText')?.value?.trim();
        if (abilityTextVal) {
          entry.abilityText = abilityTextVal;
        } else if (isAbility) {
          entry.abilityText = entry.description;
        }

        const abilityWhenVal = detail.querySelector('.kw-abilityWhen')?.value?.trim();
        if (abilityWhenVal) entry.abilityWhen = abilityWhenVal;

        // allowEmptyContent
        const allowEmptyVal = detail.querySelector('.kw-allowEmpty')?.value;
        if (allowEmptyVal === 'true') entry.allowEmptyContent = true;
        else if (allowEmptyVal === 'false') entry.allowEmptyContent = false;

        // abilityInputs
        const aiMode = detail.querySelector('.kw-aiMode')?.value;
        if (aiMode) {
          const abilityInputs = { mode: aiMode };
          const parseCSV = (sel) => {
            const v = detail.querySelector(sel)?.value?.trim();
            return v ? v.split(',').map(s => s.trim()).filter(Boolean) : [];
          };
          const req = parseCSV('.kw-aiRequired');
          const opt = parseCSV('.kw-aiOptional');
          const inf = parseCSV('.kw-aiInferFrom');
          const val = detail.querySelector('.kw-aiValidation')?.value?.trim();
          const ex = parseCSV('.kw-aiExamples');
          if (req.length) abilityInputs.required = req;
          if (opt.length) abilityInputs.optional = opt;
          if (inf.length) abilityInputs.inferFrom = inf;
          if (val) abilityInputs.validation = val;
          if (ex.length) abilityInputs.examples = ex;
          entry.abilityInputs = abilityInputs;
        }

        // retry
        const retryEnabled = detail.querySelector('.kw-retryEnabled')?.value;
        const retryMax = parseInt(detail.querySelector('.kw-retryMax')?.value, 10);
        const retryModel = detail.querySelector('.kw-retryModel')?.value?.trim();
        const retryPrompt = detail.querySelector('.kw-retryPrompt')?.value?.trim();
        const retry = {};
        if (retryEnabled === 'true') retry.enabled = true;
        else if (retryEnabled === 'false') retry.enabled = false;
        if (!isNaN(retryMax) && retryMax >= 0 && retryMax <= 10) retry.maxRetries = retryMax;
        if (retryModel) retry.model = retryModel;
        if (retryPrompt) retry.prompt = retryPrompt;
        if (Object.keys(retry).length > 0) entry.retry = retry;
      } else {
        // No detail row ‚Äî use legacy behavior for abilityText
        if (isAbility) entry.abilityText = entry.description;
      }

      keywords.push(entry);
    }
    return keywords;
  }

  // ‚îÄ‚îÄ Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveConfig() {
    const saveBtn = document.getElementById('saveBtn');
    const saveMsg = document.getElementById('saveMsg');

    // Check native input validity (e.g. pattern mismatches) before saving
    const invalidInput = document.querySelector('[data-env]:invalid');
    if (invalidInput) {
      invalidInput.reportValidity();
      return;
    }

    saveBtn.disabled = true;
    saveMsg.textContent = 'Saving‚Ä¶';
    saveMsg.className = 'msg';

    try {
      // Collect env changes ‚Äî include empty values so users can clear fields
      const env = {};
      document.querySelectorAll('[data-env]').forEach(input => {
        const key = input.dataset.env;
        // Skip DISCORD_TOKEN here ‚Äî handled specially below
        if (key === 'DISCORD_TOKEN') return;
        env[key] = input.value.trim();
      });

      // Include token only if user typed a new value (write-only field)
      const tokenInput = document.getElementById('discord_token');
      const tokenVal = tokenInput.value.trim();
      if (tokenVal) {
        env['DISCORD_TOKEN'] = tokenVal;
      }

      // Include AccuWeather API key only if user typed a new value (write-only field)
      const awKeyInput = document.getElementById('accuweather_api_key');
      const awKeyVal = awKeyInput.value.trim();
      if (awKeyVal) {
        env['ACCUWEATHER_API_KEY'] = awKeyVal;
      }

      // Include SerpAPI key only if user typed a new value (write-only field)
      const serpKeyInput = document.getElementById('serpapi_api_key');
      const serpKeyVal = serpKeyInput.value.trim();
      if (serpKeyVal) {
        env['SERPAPI_API_KEY'] = serpKeyVal;
      }

      // Include current theme preference
      env['CONFIGURATOR_THEME'] = _getCurrentTheme();

      // Collect keywords
      const keywords = collectKeywords();

      const res = await fetch('/api/config/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ env, keywords }),
      });

      const result = await res.json();

      if (result.success) {
        document.querySelectorAll('.dirty').forEach(el => el.classList.remove('dirty'));
        markClean();
        // Update server theme tracker so it no longer shows as dirty
        _serverTheme = _getCurrentTheme();
        // Clear the token input after successful save
        tokenInput.value = '';
        tokenInput.placeholder = 'Token configured ‚úì ‚Äî paste new value to change';
        // Clear the AccuWeather API key input after successful save
        if (awKeyVal) {
          awKeyInput.value = '';
          awKeyInput.placeholder = 'API key configured ‚úì ‚Äî paste new value to change';
        }
        // Clear the SerpAPI key input after successful save
        if (serpKeyVal) {
          serpKeyInput.value = '';
          serpKeyInput.placeholder = 'API key configured ‚úì ‚Äî paste new value to change';
        }
        saveMsg.textContent = result.messages.join(' | ');
        saveMsg.className = 'msg ok';
        conLog(`[${new Date().toISOString()}] Save successful`, 'ok');
        for (const m of result.messages) {
          conLog(`  ${m}`, m.includes('‚ö†') ? 'warn' : 'ok');
        }
        // Refresh status
        await pollStatus();
        await pollBotStatus();
      } else {
        saveMsg.textContent = result.error;
        saveMsg.className = 'msg err';
        saveBtn.disabled = false;
        conLog(`[${new Date().toISOString()}] Save failed: ${result.error}`, 'err');
      }
    } catch (e) {
      saveMsg.textContent = `Error: ${e.message}`;
      saveMsg.className = 'msg err';
      saveBtn.disabled = false;
      conLog(`[${new Date().toISOString()}] Save error: ${e.message}`, 'err');
    }
  }

  // ‚îÄ‚îÄ Test connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function testConnection(api) {
    conLog(`[${new Date().toISOString()}] Testing ${api} connection‚Ä¶`);
    try {
      const res = await fetch(`/api/config/test-connection/${api}`);
      const data = await res.json();
      if (data.healthy) {
        conLog(`  ‚úì ${api} at ${data.endpoint} is reachable`, 'ok');

        // For Ollama, populate model dropdown from returned models
        if (api === 'ollama' && data.models && data.models.length > 0) {
          const modelSelect = document.getElementById('ollama_model');
          const currentValue = modelSelect.value;
          modelSelect.innerHTML = '';

          // Add default empty option
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = '‚Äî select a model ‚Äî';
          modelSelect.appendChild(defaultOpt);

          // Add each model
          for (const model of data.models) {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = `${model.name} (${model.parameterSize}, ${model.family}, ${model.quantization})`;
            modelSelect.appendChild(opt);
          }

          // Restore previous selection if it still exists
          if (currentValue) {
            const exists = Array.from(modelSelect.options).some(o => o.value === currentValue);
            if (exists) {
              modelSelect.value = currentValue;
            }
          }

          // Also populate the Final Pass Model dropdown
          const fpModelSelect = document.getElementById('ollama_final_pass_model');
          const fpCurrentValue = fpModelSelect.value;
          fpModelSelect.innerHTML = '';
          const fpDefaultOpt = document.createElement('option');
          fpDefaultOpt.value = '';
          fpDefaultOpt.textContent = '‚Äî use default model ‚Äî';
          fpModelSelect.appendChild(fpDefaultOpt);
          for (const model of data.models) {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = `${model.name} (${model.parameterSize}, ${model.family}, ${model.quantization})`;
            fpModelSelect.appendChild(opt);
          }
          if (fpCurrentValue) {
            const exists = Array.from(fpModelSelect.options).some(o => o.value === fpCurrentValue);
            if (exists) fpModelSelect.value = fpCurrentValue;
          }

          conLog(`  ‚úì Found ${data.models.length} model(s)`, 'ok');
          for (const m of data.models) {
            conLog(`    ‚Ä¢ ${m.name} (${m.parameterSize}, ${m.family})`);
          }
        }

        // For AccuWeather, show resolved location info
        if (api === 'accuweather') {
          const resultEl = document.getElementById('accuweatherTestResult');
          if (data.location) {
            const loc = data.location;
            resultEl.innerHTML = `<span style="color:var(--ok)">‚úì API key valid. Default location: ${loc.LocalizedName}, ${loc.AdministrativeArea?.ID || ''}, ${loc.Country?.LocalizedName || ''} (key: ${loc.Key})</span>`;
            conLog(`  ‚úì Default location resolved: ${loc.LocalizedName}, ${loc.AdministrativeArea?.ID || ''}`, 'ok');
          } else {
            resultEl.innerHTML = '<span style="color:var(--ok)">‚úì API key valid. No default location configured.</span>';
          }
        }

        // For NFL, show success status
        if (api === 'nfl') {
          const resultEl = document.getElementById('nflTestResult');
          resultEl.innerHTML = '<span style="color:var(--ok)">‚úì API key valid. NFL data available.</span>';
        }

        // For SerpAPI, show success status
        if (api === 'serpapi') {
          const resultEl = document.getElementById('serpapiTestResult');
          resultEl.innerHTML = '<span style="color:var(--ok)">‚úì API key valid. SerpAPI is reachable.</span>';
        }
      } else {
        conLog(`  ‚úó ${api} at ${data.endpoint} is not reachable`, 'err');
        if (data.error) conLog(`    ${data.error}`, 'err');

        if (api === 'accuweather') {
          const resultEl = document.getElementById('accuweatherTestResult');
          resultEl.innerHTML = `<span style="color:var(--err)">‚úó ${data.error || 'Connection failed'}</span>`;
        }
        if (api === 'nfl') {
          const resultEl = document.getElementById('nflTestResult');
          resultEl.innerHTML = `<span style="color:var(--err)">‚úó ${data.error || 'Connection failed'}</span>`;
        }
        if (api === 'serpapi') {
          const resultEl = document.getElementById('serpapiTestResult');
          resultEl.innerHTML = `<span style="color:var(--err)">‚úó ${data.error || 'Connection failed'}</span>`;
        }
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ‚úó Test failed: ${e.message}`, 'err');
    }
  }

  // ‚îÄ‚îÄ Discord controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function testDiscord() {
    const token = document.getElementById('discord_token').value.trim();
    if (!token) {
      conLog(`[${new Date().toISOString()}] Enter a token to test`, 'warn');
      return;
    }
    conLog(`[${new Date().toISOString()}] Testing Discord token‚Ä¶`);
    try {
      const res = await fetch('/api/discord/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });
      const data = await res.json();
      if (data.success) {
        conLog(`  ‚úì ${data.message}`, 'ok');
      } else {
        conLog(`  ‚úó ${data.message}`, 'err');
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ‚úó Test failed: ${e.message}`, 'err');
    }
  }

  async function startBot() {
    conLog(`[${new Date().toISOString()}] Starting Discord bot‚Ä¶`);
    document.getElementById('btnStart').disabled = true;
    try {
      const res = await fetch('/api/discord/start', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '‚úì' : '‚úó'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      // Poll bot status a few times to catch the ready event
      for (let i = 0; i < 5; i++) {
        await new Promise(r => setTimeout(r, 1000));
        await pollBotStatus();
      }
    } catch (e) {
      conLog(`  ‚úó Start failed: ${e.message}`, 'err');
      document.getElementById('btnStart').disabled = false;
    }
  }

  async function stopBot() {
    conLog(`[${new Date().toISOString()}] Stopping Discord bot‚Ä¶`);
    document.getElementById('btnStop').disabled = true;
    try {
      const res = await fetch('/api/discord/stop', { method: 'POST' });
      const data = await res.json();
      conLog(`  ${data.success ? '‚úì' : '‚úó'} ${data.message}`, data.success ? 'ok' : 'err');
      await pollStatus();
      await pollBotStatus();
    } catch (e) {
      conLog(`  ‚úó Stop failed: ${e.message}`, 'err');
      document.getElementById('btnStop').disabled = false;
    }
  }

  // ‚îÄ‚îÄ Workflow upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function handleWorkflowUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const statusEl = document.getElementById('workflowStatus');
    statusEl.innerHTML = '<span style="color:var(--warn)">Uploading‚Ä¶</span>';
    conLog(`[${new Date().toISOString()}] Uploading workflow: ${file.name}‚Ä¶`);

    try {
      const text = await file.text();

      const res = await fetch('/api/config/upload-workflow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workflow: text, filename: file.name }),
      });

      const data = await res.json();

      if (data.success) {
        const convertedNote = data.converted ? ' [auto-converted from UI format]' : '';
        statusEl.innerHTML = `<span style="color:var(--ok)">‚úì ${esc(file.name)} ‚Äî validation passed${convertedNote}</span>`;
        conLog(`  ‚úì Workflow "${file.name}" uploaded and validated${convertedNote}`, 'ok');
        if (data.converted) {
          conLog('  ‚Ñπ Workflow was in ComfyUI UI format and auto-converted to API format. For best results, export using "Save (API Format)" in ComfyUI.', 'warn');
        }
        _hasCustomWorkflow = true;
        document.getElementById('customWorkflowActions').style.display = '';
        updateDefaultWorkflowInfo();
      } else {
        statusEl.innerHTML = `<span style="color:var(--err)">‚úó ${esc(file.name)} ‚Äî ${esc(data.error)}</span>`;
        conLog(`  ‚úó Workflow validation failed: ${data.error}`, 'err');
      }

      await pollStatus();
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">‚úó Upload failed: ${esc(e.message)}</span>`;
      conLog(`  ‚úó Workflow upload failed: ${e.message}`, 'err');
    }

    // Reset the file input so the same file can be re-uploaded
    input.value = '';
  }

  // ‚îÄ‚îÄ Default workflow management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function discoverComfyUIOptions() {
    conLog(`[${new Date().toISOString()}] Discovering ComfyUI options‚Ä¶`);
    try {
      const [samplersRes, schedulersRes, checkpointsRes] = await Promise.all([
        fetch('/api/config/comfyui/samplers'),
        fetch('/api/config/comfyui/schedulers'),
        fetch('/api/config/comfyui/checkpoints'),
      ]);

      const samplers = await samplersRes.json();
      const schedulers = await schedulersRes.json();
      const checkpoints = await checkpointsRes.json();

      // Populate sampler dropdown
      if (Array.isArray(samplers) && samplers.length > 0) {
        const samplerSelect = document.getElementById('dw_sampler');
        const currentSampler = samplerSelect.value;
        samplerSelect.innerHTML = '';
        for (const s of samplers) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          samplerSelect.appendChild(opt);
        }
        if (samplers.includes(currentSampler)) samplerSelect.value = currentSampler;
        conLog(`  ‚úì Found ${samplers.length} sampler(s)`, 'ok');
      } else {
        conLog('  ‚ö† No samplers returned ‚Äî using defaults', 'warn');
      }

      // Populate scheduler dropdown
      if (Array.isArray(schedulers) && schedulers.length > 0) {
        const schedulerSelect = document.getElementById('dw_scheduler');
        const currentScheduler = schedulerSelect.value;
        schedulerSelect.innerHTML = '';
        for (const s of schedulers) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          schedulerSelect.appendChild(opt);
        }
        if (schedulers.includes(currentScheduler)) schedulerSelect.value = currentScheduler;
        conLog(`  ‚úì Found ${schedulers.length} scheduler(s)`, 'ok');
      } else {
        conLog('  ‚ö† No schedulers returned ‚Äî using defaults', 'warn');
      }

      // Populate checkpoint dropdown
      if (Array.isArray(checkpoints) && checkpoints.length > 0) {
        const modelSelect = document.getElementById('dw_model');
        const currentModel = modelSelect.value;
        modelSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '‚Äî select a checkpoint ‚Äî';
        modelSelect.appendChild(defaultOpt);
        for (const c of checkpoints) {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          modelSelect.appendChild(opt);
        }
        if (currentModel && checkpoints.includes(currentModel)) modelSelect.value = currentModel;
        conLog(`  ‚úì Found ${checkpoints.length} checkpoint(s)`, 'ok');
      } else {
        conLog('  ‚ö† No checkpoints returned ‚Äî ensure ComfyUI is connected', 'warn');
      }
    } catch (e) {
      conLog(`  ‚úó Discovery failed: ${e.message}. Test ComfyUI connection first.`, 'err');
    }
  }

  async function saveDefaultWorkflow() {
    const statusEl = document.getElementById('dwSaveStatus');
    const model = document.getElementById('dw_model').value;
    if (!model) {
      statusEl.textContent = 'Select a checkpoint model first';
      statusEl.style.color = 'var(--err)';
      return;
    }

    const params = {
      model,
      width: parseInt(document.getElementById('dw_width').value) || 512,
      height: parseInt(document.getElementById('dw_height').value) || 512,
      steps: parseInt(document.getElementById('dw_steps').value) || 20,
      cfg: parseFloat(document.getElementById('dw_cfg').value) || 7.0,
      sampler: document.getElementById('dw_sampler').value || 'euler_ancestral',
      scheduler: document.getElementById('dw_scheduler').value || 'beta',
      denoise: parseFloat(document.getElementById('dw_denoise').value),
      seed: parseInt(document.getElementById('dw_seed').value),
    };

    if (isNaN(params.denoise)) params.denoise = 0.88;
    if (isNaN(params.seed)) params.seed = -1;

    statusEl.textContent = 'Saving‚Ä¶';
    statusEl.style.color = 'var(--text-dim)';
    conLog(`[${new Date().toISOString()}] Saving default workflow settings‚Ä¶`);

    try {
      const res = await fetch('/api/config/default-workflow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params),
      });
      const data = await res.json();
      if (data.success) {
        statusEl.textContent = 'Saved ‚úì';
        statusEl.style.color = 'var(--ok)';
        conLog('  ‚úì Default workflow settings saved', 'ok');
        updateDefaultWorkflowInfo();
      } else {
        const errMsg = data.errors ? data.errors.join(', ') : (data.error || 'Unknown error');
        statusEl.textContent = 'Error: ' + errMsg;
        statusEl.style.color = 'var(--err)';
        conLog(`  ‚úó Save failed: ${errMsg}`, 'err');
      }
    } catch (e) {
      statusEl.textContent = 'Error: ' + e.message;
      statusEl.style.color = 'var(--err)';
      conLog(`  ‚úó Save failed: ${e.message}`, 'err');
    }
  }

  async function deleteCustomWorkflow() {
    if (!confirm('Remove the custom workflow? The default workflow settings will be used instead.')) return;
    conLog(`[${new Date().toISOString()}] Removing custom workflow‚Ä¶`);
    try {
      const res = await fetch('/api/config/workflow', { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        conLog('  ‚úì ' + data.message, 'ok');
        _hasCustomWorkflow = false;
        document.getElementById('workflowStatus').innerHTML = '<span style="color:var(--text-dim)">No workflow uploaded</span>';
        document.getElementById('customWorkflowActions').style.display = 'none';
        updateDefaultWorkflowInfo();
      } else {
        conLog('  ‚úó ' + (data.error || 'Failed'), 'err');
      }
    } catch (e) {
      conLog(`  ‚úó Delete failed: ${e.message}`, 'err');
    }
  }

  async function exportWorkflow() {
    const statusEl = document.getElementById('exportStatus');
    statusEl.innerHTML = '<span style="color:var(--warn)">Exporting‚Ä¶</span>';
    conLog(`[${new Date().toISOString()}] Exporting current workflow‚Ä¶`);
    try {
      const res = await fetch('/api/config/workflow/export');
      const data = await res.json();
      if (data.success) {
        const blob = new Blob([JSON.stringify(data.workflow, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'comfyui-workflow-export.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        statusEl.innerHTML = `<span style="color:var(--ok)">‚úì Exported (${data.source})</span>`;
        conLog(`  ‚úì Workflow exported (source: ${data.source})`, 'ok');
      } else {
        statusEl.innerHTML = `<span style="color:var(--err)">‚úó ${esc(data.error)}</span>`;
        conLog(`  ‚úó Export failed: ${data.error}`, 'err');
      }
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">‚úó ${esc(e.message)}</span>`;
      conLog(`  ‚úó Export failed: ${e.message}`, 'err');
    }
  }

  // Tracks whether a custom workflow is currently uploaded (set from config API, not DOM text)
  let _hasCustomWorkflow = false;

  function updateDefaultWorkflowInfo() {
    const infoEl = document.getElementById('defaultWorkflowInfo');
    const hasCustom = _hasCustomWorkflow;
    const hasModel = document.getElementById('dw_model').value;

    document.getElementById('customWorkflowActions').style.display = hasCustom ? '' : 'none';

    if (hasCustom) {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(255,183,77,0.08)';
      infoEl.style.border = '1px solid rgba(255,183,77,0.3)';
      infoEl.innerHTML = '‚ö† A custom workflow is uploaded and takes precedence. Default workflow settings are saved but inactive.';
    } else if (hasModel) {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(129,199,132,0.08)';
      infoEl.style.border = '1px solid rgba(129,199,132,0.3)';
      infoEl.innerHTML = '‚úì Default workflow is active with the settings below.';
    } else {
      infoEl.style.display = '';
      infoEl.style.background = 'rgba(144,164,174,0.08)';
      infoEl.style.border = '1px solid rgba(144,164,174,0.3)';
      infoEl.innerHTML = 'No workflow configured. Select a checkpoint model and save to enable the default workflow.';
    }
  }

  // ‚îÄ‚îÄ Test image generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function testGenerateImage() {
    const prompt = document.getElementById('testPrompt').value.trim();
    if (!prompt) {
      conLog(`[${new Date().toISOString()}] Enter a prompt to test image generation`, 'warn');
      return;
    }

    const btn = document.getElementById('btnTestGenerate');
    const statusEl = document.getElementById('testGenStatus');
    const resultsEl = document.getElementById('testGenResults');
    const imagesEl = document.getElementById('testGenImages');

    btn.disabled = true;
    btn.textContent = '‚è≥';
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<span style="color:var(--warn)">‚è≥ Generating‚Ä¶ this may take a few minutes</span>';
    resultsEl.style.display = 'none';
    imagesEl.innerHTML = '';

    conLog(`[${new Date().toISOString()}] Test image generation started ‚Äî "${prompt.substring(0, 80)}"‚Ä¶`);

    try {
      const res = await fetch('/api/test/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt }),
      });

      const data = await res.json();

      if (data.success && data.images && data.images.length > 0) {
        statusEl.innerHTML = `<span style="color:var(--ok)">‚úì Generated ${data.images.length} image(s)</span>`;
        resultsEl.style.display = 'block';

        for (const url of data.images) {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'border:1px solid var(--border);border-radius:4px;overflow:hidden;background:var(--surface)';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Generated image';
          img.style.cssText = 'max-width:256px;max-height:256px;display:block';
          img.onerror = function() { this.alt = 'Failed to load image'; this.style.padding = '20px'; };

          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.style.cssText = 'display:block;font-size:0.75em;padding:4px 8px;color:var(--text-dim);word-break:break-all';
          link.textContent = url;

          wrapper.appendChild(img);
          wrapper.appendChild(link);
          imagesEl.appendChild(wrapper);
        }

        conLog(`  ‚úì Test generation complete ‚Äî ${data.images.length} image(s)`, 'ok');
        for (const url of data.images) {
          conLog(`    ‚Ä¢ ${url}`);
        }
      } else {
        const errMsg = data.error || 'Generation failed ‚Äî no images returned';
        statusEl.innerHTML = `<span style="color:var(--err)">‚úó ${esc(errMsg)}</span>`;
        resultsEl.style.display = 'none';
        conLog(`  ‚úó Test generation failed: ${errMsg}`, 'err');
      }
    } catch (e) {
      statusEl.innerHTML = `<span style="color:var(--err)">‚úó ${esc(e.message)}</span>`;
      resultsEl.style.display = 'none';
      conLog(`  ‚úó Test generation error: ${e.message}`, 'err');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
      await pollStatus();
    }
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function esc(s) {
    return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function escXml(s) {
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
  }

  /**
   * Classify a log line for color coding.
   * Shared between compact console and expanded modal.
   */
  function classifyLine(line) {
    if (line.includes('[error]')) return 'err';
    if (line.includes('[warn]')) return 'warn';
    if (line.includes(' OK') || line.includes('started') || line.includes('logged in') || line.includes('saved') || line.includes('Authenticated') || line.includes('Loaded ')) return 'ok';
    return '';
  }

  // ‚îÄ‚îÄ Log Modal (expanded viewer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _logModalOpen = false;

  function openLogModal() {
    _logModalOpen = true;
    document.getElementById('logModalBackdrop').classList.add('open');
    document.getElementById('logModal').classList.add('open');
    fetchFullLog();
  }

  function closeLogModal() {
    _logModalOpen = false;
    document.getElementById('logModalBackdrop').classList.remove('open');
    document.getElementById('logModal').classList.remove('open');
  }

  async function fetchFullLog() {
    const body = document.getElementById('logModalBody');
    body.innerHTML = '<div class="line" style="color:var(--text-dim)">Loading‚Ä¶</div>';
    try {
      const res = await fetch('/api/config/log/full');
      const data = await res.json();
      body.innerHTML = '';
      for (const line of data.lines) {
        const d = document.createElement('div');
        d.className = 'line';
        const cls = classifyLine(line);
        if (cls) d.classList.add(cls);
        d.textContent = line;
        body.appendChild(d);
      }
      // Scroll to bottom
      body.scrollTop = body.scrollHeight;
    } catch (e) {
      body.innerHTML = `<div class="line err">Failed to load log: ${esc(e.message)}</div>`;
    }
  }

  // Close modal on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && _logModalOpen) {
      closeLogModal();
    }
  });

  // ‚îÄ‚îÄ Rotate Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function rotateLog() {
    conLog(`[${new Date().toISOString()}] Rotating log‚Ä¶`);
    try {
      const res = await fetch('/api/config/log/rotate', { method: 'POST' });
      const data = await res.json();
      if (data.success && data.archivedName) {
        conLog(`  ‚úì Log archived as ${data.archivedName}`, 'ok');
      } else {
        conLog(`  ‚Ñπ ${data.message || 'Nothing to rotate'}`, 'warn');
      }
      await pollStatus();
    } catch (e) {
      conLog(`  ‚úó Rotate failed: ${e.message}`, 'err');
    }
  }

  // ‚îÄ‚îÄ Generate Activity Key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function generateActivityKey() {
    const btn = document.getElementById('btnGenKey');
    const resultEl = document.getElementById('activityKeyResult');
    btn.disabled = true;
    resultEl.innerHTML = '';
    conLog(`[${new Date().toISOString()}] Generating activity key‚Ä¶`);
    try {
      const res = await fetch('/api/config/activity-key', { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        resultEl.innerHTML = `<span class="activity-key-result">` +
          `<code id="actKeyValue">${esc(data.key)}</code>` +
          `<span class="ttl">TTL: ${data.ttl}s</span>` +
          `<button class="btn-sm btn-secondary" onclick="copyActivityKey()" title="Copy key to clipboard">üìã Copy</button>` +
          `<a href="${esc(data.activityUrl)}" target="_blank" style="font-size:0.85em;color:var(--accent)">Open</a>` +
          `</span>`;
        conLog(`  ‚úì Activity key issued (TTL: ${data.ttl}s)`, 'ok');
      } else {
        resultEl.innerHTML = `<span style="color:var(--err);font-size:0.82em">${esc(data.error || 'Failed')}</span>`;
        conLog(`  ‚úó Activity key failed: ${data.error || 'unknown'}`, 'err');
      }
    } catch (e) {
      resultEl.innerHTML = `<span style="color:var(--err);font-size:0.82em">${esc(e.message)}</span>`;
      conLog(`  ‚úó Activity key error: ${e.message}`, 'err');
    } finally {
      btn.disabled = false;
    }
  }

  async function copyActivityKey() {
    const keyEl = document.getElementById('actKeyValue');
    if (!keyEl) return;
    try {
      await navigator.clipboard.writeText(keyEl.textContent);
      conLog('  ‚úì Activity key copied to clipboard', 'ok');
    } catch {
      conLog('  ‚úó Clipboard copy failed', 'err');
    }
  }

  // ‚îÄ‚îÄ Theme Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function _getCurrentTheme() {
    const match = document.documentElement.className.match(/theme-([\w-]+)/);
    return match ? match[1] : 'dark';
  }

  function applyTheme(themeName, fromServer) {
    const root = document.documentElement;
    // Remove all theme classes (supports hyphenated names like 'theme-black-cyan')
    root.className = root.className.replace(/theme-[\w-]+/g, '');
    // Add the new theme class
    root.classList.add(`theme-${themeName}`);
    
    // Update active state on UI
    document.querySelectorAll('.theme-option').forEach(option => {
      option.classList.toggle('active', option.dataset.theme === themeName);
    });
    
    // Store preference in localStorage as fallback
    localStorage.setItem('configurator-theme', themeName);

    // If this was a user-initiated change (not from server load), mark dirty
    if (!fromServer && themeName !== _serverTheme) {
      markDirty();
    }
    // If user switches back to the server theme, update the server tracker
    if (fromServer) {
      _serverTheme = themeName;
    }
  }

  // Load saved theme preference (localStorage fallback until server config loads)
  document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('configurator-theme') || 'dark';
    applyTheme(savedTheme, /* fromServer */ true);
    
    // Add click handlers for theme options
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        applyTheme(option.dataset.theme);
      });
    });
  });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  attachDirtyListeners();
  loadConfig();
  pollStatus();
  pollBotStatus();
  setInterval(pollStatus, 5000);
  setInterval(pollBotStatus, 3000);
</script>
</body>
</html>
